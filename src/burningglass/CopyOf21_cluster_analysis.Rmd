---
title: "21_cluster_analysis"
author: "Joanna Schroeder"
date: "11/18/2020"
output: html_document
---

The purpose of this document is to put together cluster analysis of the BGT Resume data for nonveterans and veterans. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	message = FALSE
)
for (pkg in c("tidyverse",  "data.table", "R.utils", "mosaic", "readr", "maditr", "stringr", "stringi", "dplyr", "ggplot2", "lubridate", "gt", "DataExplorer", "TraMineR", "TraMineRextras", "cluster", "tools", "WeightedCluster", "viridis", "splitstackshape", "scales")) {
  library(pkg, character.only = TRUE)
}

uva_color_palette <- 
c("#232D4B", #space cadet
  "#2C4F6B", #indigo dye
  "#0E879C", #blue munsell
  "#60999A", #cadet blue
  "#D1E0BF", #tea green
  "#D9E12B", #pear
  "#E6CE3A", #citrine
  "#E6A01D", #marigold
  "#E57200" #princeton orange
)
```

```{r clean-data, include = FALSE}
# Accessing and cleaning data for the analysis

# Functions to clean the BGT data and sequences analysis functions
# Scripts to access and clean BGT data are commented out and the final datasets are read in
#source("~/git/DSPG2020/career/src/burningglass/20_updated_clean_bgt.R")
source("~/git/DSPG2020/career/src/burningglass/master_functions.R")

# This function can be used to access and clean BGT data by state (in our case, we access and clean resume data for DC, Maryland, and Virginia)
#bg_cleaned <- get_bgt_data_for_state(states = c("DC", "MD", "VA"))

#bg_covariates <- as.data.table(bg_cleaned$bg_covariates)
#bg_job <- as.data.table(bg_cleaned$bg_job)
#all_majors <- as.data.table(bg_cleaned$all_majors)
#all_skills <- as.data.table(bg_cleaned$all_skills)
#highest_degree_majors <- as.data.table(bg_cleaned$highest_degree_majors)
#top_skills <- as.data.table(bg_cleaned$top_skills)

#write.csv(bg_covariates, file= "~/git/DSPG2020/career/data/testing.csv", row.names = F)
#write.csv(bg_job, file= "~/git/DSPG2020/career/data/bg_job_vadcmd.csv", row.names = F)
#write.csv(all_majors, file= "~/git/DSPG2020/career/data/all_majors_vadcmd.csv", row.names = F)
#write.csv(all_skills, file= "~/git/DSPG2020/career/data/all_skills_vadcmd.csv", row.names = F)
#write.csv(highest_degree_majors, file= "~/git/DSPG2020/career/data/highest_degree_majors_vadcmd.csv", row.names = F)
#write.csv(top_skills, file= "~/git/DSPG2020/career/data/top_skills_vadcmd.csv", row.names = F)

# Reading in final datasets and archive datasets (covariates obtained from previous cleaning function from the summer)
bg_covariates <- fread("~/git/DSPG2020/career/data/bg_covariates_vadcmd.csv")
bg_job <- fread("~/git/DSPG2020/career/data/bg_job_vadcmd.csv")
all_skills <- fread("~/git/DSPG2020/career/data/all_skills_vadcmd.csv")
all_majors <- fread("~/git/DSPG2020/career/data/all_majors_vadcmd.csv")
top_skills <- fread("~/git/DSPG2020/career/data/top_skills_vadcmd.csv")
top_majors <- fread("~/git/DSPG2020/career/data/highest_degree_majors_vadcmd.csv")
archive_covariates <- fread("~/git/DSPG2020/career/data/02_bg_vet_demographic.csv")
archive_job <- fread("~/git/DSPG2020/career/data/03_bg_all_job.csv") %>% select(id, onet_job_zone, start_year, end_year)

# The above function cleans and formats the data for the most part but some cleaning is done outside of the script

# Recleaning the year_entered_civilian_workforce variable
year_entered_civilian_workforce <- bg_job %>% left_join(bg_covariates, by = "id") %>%
  mutate(duration = end_year - start_year + 1) %>% group_by(id) %>%
  mutate(aligned_start = min(start_year)) %>% ungroup() %>% filter(onet_job_zone != 55) %>%
  mutate(out = ifelse(veteran == "veteran" & start_year < year_military_exit, 1, 0)) %>%
  group_by(id, out) %>%
  mutate(year_entered_civilian_workforce = min(start_year)) %>% group_by(id) %>%
  mutate(year_entered_civilian_workforce = max(start_year),
         military_transition_unemployment = ifelse((year_entered_civilian_workforce -
                                                     year_military_exit) < 0, 0,
                                                   year_entered_civilian_workforce -
                                                     year_military_exit)) %>%
  select(id, aligned_start, year_entered_civilian_workforce, military_transition_unemployment)

# Joining in recleaned year_entered_civilian_workforce variable
bg_covariates <- bg_covariates %>% select(-aligned_start, -year_entered_civilian_workforce) %>% left_join(year_entered_civilian_workforce, by = "id") %>% distinct()

bg_covariates %>% filter(veteran == "veteran") %>% arrange(year_military_enlist)
```

```{r fixing-duplicates, include = FALSE}
# Here we create bins for some variables for analysis/visualization and we address duplicated ids in the BGT data

bg_covariates <- bg_covariates %>%
  mutate(irr_bin = ntile(irr, 5),
         years_in_military_bin = case_when(
        years_in_military >= 1 & years_in_military <= 2 | years_in_military < 0
~ "1 - 2",
years_in_military >= 3 & years_in_military <= 4 ~ "3 - 4",
years_in_military >= 5 & years_in_military <= 10 ~ "5 - 10",
years_in_military >= 11 & years_in_military <= 20 ~ "11 - 20",
years_in_military >= 21 & years_in_military <= 30 ~ "21 - 30",
years_in_military >= 31 ~ "31+"),
year_military_enlist_bin = case_when(
year_military_enlist >= 2001 ~ "2001 or later",
year_military_enlist >= 1990 & year_military_enlist < 2001 ~ "1990 to 2000 (including Persian Gulf War)",
year_military_enlist >= 1975 & year_military_enlist < 1990 ~ "1975 to 1989",
year_military_enlist >= 1964 & year_military_enlist < 1975 ~ "Vietnam era (1964 to 1974)",
year_military_enlist >= 1955 & year_military_enlist < 1964 ~ "1955 to 1963",
year_military_enlist >= 1950 & year_military_enlist < 1955 ~ "Korean war (1950 to 1954)",
year_military_enlist >= 1947 & year_military_enlist < 1950 ~ "1947 to 1949",
year_military_enlist >= 1941 & year_military_enlist < 1947 ~ " World War II (1941 to 1946)",
year_military_enlist < 1941 ~ "1940 or earlier"),
year_entered_workforce_bin = case_when(
aligned_start >= 2017 ~ "Post-Millennial",
aligned_start >= 2001 & aligned_start < 2017 ~ "Millennial",
aligned_start >= 1985 & aligned_start < 2001 ~ "Generation X",
aligned_start >= 1966 & aligned_start < 1985 ~ "Baby Boom",
aligned_start < 1966 ~ "Silent and Greatest"
),
career_before_military_bin = case_when(
career_before_military == 0 ~ "0",
career_before_military >= 1 & career_before_military < 5 ~ "1 - 4",
career_before_military >= 5 & career_before_military < 11 ~ "5 - 10",
career_before_military >= 11 & career_before_military < 21 ~ "11 - 20",
career_before_military >= 21 & career_before_military < 31 ~ "21 - 30",
career_before_military >= 31 ~ "31+"),
military_transition_unemployment_bin = case_when(
military_transition_unemployment == 0 ~ "0",
military_transition_unemployment >= 1 & military_transition_unemployment < 5 ~ "1 - 4",
military_transition_unemployment >= 5 & military_transition_unemployment < 11 ~ "5 - 10",
military_transition_unemployment >= 11 & military_transition_unemployment < 21 ~ "11 - 20",
military_transition_unemployment >= 21 & military_transition_unemployment < 30 ~ "21 - 30",
military_transition_unemployment >= 31 ~ "31+"))
duplicates <- bg_covariates$id[duplicated(bg_covariates$id)]
# Dealing with duplicates
bg_covariates_nodup <- bg_covariates %>% filter(!(id %in% duplicates))
fixed_55 <- bg_covariates %>% filter(id %in% bg_covariates$id[duplicated(bg_covariates$id)]) %>%
mutate(all_other = ifelse(
(end_onet55 == "55-3019.00" | end_onet55 == "55-1019.00"), "all_other", end_onet55))%>% mutate(end_onet55_score = case_when(
all_other != "all_other" ~ 1,
all_other == "all_other" & end_onet55 == "55-1019.00" ~ 2,
all_other == "all_other" & end_onet55 == "55-3019.00" ~ 3)) %>% group_by(id) %>%
mutate(end_onet55_true = ifelse(end_onet55_score == max(end_onet55_score), end_onet55, NA)) %>% drop_na(end_onet55_true) %>% mutate(duplicated = ifelse(duplicated(id) == TRUE, TRUE, FALSE)) %>% filter(duplicated == FALSE) %>% distinct() %>% select(-all_other, -end_onet55_score, -end_onet55_true, -duplicated) %>% filter(id %in% c(218335843, 219487198))
fixed_gender <- bg_covariates %>% filter(id %in% bg_covariates$id[duplicated(bg_covariates$id)]) %>%
mutate(all_other = ifelse(
(end_onet55 == "55-3019.00" | end_onet55 == "55-1019.00"), "all_other", end_onet55))%>% mutate(end_onet55_score = case_when(
all_other != "all_other" ~ 1,
all_other == "all_other" & end_onet55 == "55-1019.00" ~ 2,
all_other == "all_other" & end_onet55 == "55-3019.00" ~ 3)) %>% group_by(id) %>%
mutate(end_onet55_true = ifelse(end_onet55_score == max(end_onet55_score), end_onet55, NA)) %>% drop_na(end_onet55_true) %>% mutate(duplicated = ifelse(duplicated(id) == TRUE, TRUE, FALSE)) %>% filter(duplicated == TRUE) %>% select(-all_other, -end_onet55_score, -end_onet55_true, -duplicated)
bg_covariates <- rbind(bg_covariates_nodup, fixed_55, fixed_gender) %>% distinct()

# STRATIFICATION --------------------------------------
# We are collapsing a few categories: post-bacc becomes bachelors, Post-Millenial becomes Millenial, Silent and Greatest becomes Baby Boom
#collapsed <- bg_covariates %>% select(id, veteran, gender, year_entered_workforce_bin, irr_bin, highest_degree) %>% mutate(highest_degree = ifelse(highest_degree == "post-bacc", "bachelors", highest_degree), year_entered_workforce_bin = ifelse(year_entered_workforce_bin == "Post-Millennial", "Millennial", ifelse(year_entered_workforce_bin == "Silent and Greatest", "Baby Boom", year_entered_workforce_bin)))

#sample <- collapsed %>% filter(veteran == "not veteran")
#stratified <- stratified(sample, c("gender",  "year_entered_workforce_bin", "irr_bin", "highest_degree"), 0.015)
           
#table(stratified$gender, stratified$year_entered_workforce_bin, stratified$irr_bin, stratified$highest_degree)

#sample %>% mutate(total = n()) %>% group_by(highest_degree) %>% mutate(percent = round(n()/total * 100, 2)) %>% distinct(highest_degree, percent) %>% arrange(-percent)
#stratified %>% mutate(total = n()) %>% group_by(gender, irr_bin, year_entered_workforce_bin, highest_degree) %>% mutate(percent = round(n()/total * 100, 2)) %>% distinct(highest_degree, percent) %>% arrange(-percent)

#write.csv(nonvet_ids, "nonvet_ids.csv")
nonvet_ids <- read.csv("~/git/DSPG2020/career/src/burningglass/nonvet_ids.csv", colClasses=c("NULL", NA)) %>% pull(x)

vet_ids <- bg_covariates %>% filter(veteran == "veteran") %>% pull(id)
#nonvet_ids <- stratified %>% pull(id)
ids <- c(vet_ids, nonvet_ids)

bg_job_full <- bg_job
bg_covariates_full <- bg_covariates
all_majors_full <- all_majors
top_majors_full <- top_majors
all_skills_full <- all_skills
top_skills_full <- top_skills

# Subsetting the original datasets by ids of the subset

bg_job <- bg_job %>% filter(id %in% ids)
bg_covariates <- bg_covariates %>% filter(id %in% ids)
all_majors <- all_majors %>% filter(id %in% ids)
top_majors <- top_majors %>% filter(id %in% ids)
all_skills <- all_skills %>% filter(id %in% ids)
top_skills <- top_skills %>% filter(id %in% ids)

# Here we are creating a new variable for highest degree earned from forprofit and hbcu 
# Eventually this code (and all the other cleaning code in this markdown) will be folded into the function, but it is faster to do it here for now

# Connecting to the burning glass data
# HIGHEST DEGREE BY INSTITUTION
get_db_conn <-
  function(db_name = "sdad",
           db_host = "postgis1",
           db_port = "5432",
           db_user = Sys.getenv("db_usr"),
           db_pass = Sys.getenv("db_pwd")) {
    RPostgreSQL::dbConnect(
      drv = RPostgreSQL::PostgreSQL(),
      dbname = db_name,
      host = db_host,
      port = db_port,
      user = db_user,
      password = db_pass
    )
  }

#uszips <- fread("~/git/DSPG2020/career/src/burningglass/uszips.csv")
#zips <- uszips %>% filter(state_id %in% c("DC", "MD", "VA")) %>% pull(zip)

con <- get_db_conn()

# Getting education data for ids
ed <- DBI::dbGetQuery(con, paste("SELECT * FROM bgt_res.ed WHERE id IN (", paste(ids, collapse = ", "), ")"))
ed <-ed[,1:12]

#job <- DBI::dbGetQuery(con, paste("SELECT * FROM bgt_res.job WHERE id IN (", paste(vet_ids, collapse = ", "), ")")) %>% filter(!is.na(onet) &  !is.na(startdate) & !is.na(enddate))
#job <- job[, 1:9]

DBI::dbDisconnect(con)

# Reading in institution id data to create the variables
forprofit <- fread("~/git/DSPG2020/career/src/burningglass/ipeds_forprofit.csv") %>% pull(UnitID)
hbcu <- fread("~/git/DSPG2020/career/src/burningglass/ipeds_hbcu.csv") %>% pull(UnitID)
tribal <- fread("~/git/DSPG2020/career/src/burningglass/ipeds_tribal.csv") %>% pull(UnitID)

highest_degree_from_forprofit <- ed %>% separate_rows(degreelevel, sep = "#") %>% 
  select(id, degreelevel, ipeds_unit_id) %>% filter(ipeds_unit_id %in% forprofit) %>% group_by(id) %>% mutate(highest_degree_from_forprofit = case_when(
  max(degreelevel, na.rm = TRUE) == 12 ~ "highschool",
  max(degreelevel, na.rm = TRUE) == 13 ~ "GED/diploma",
  max(degreelevel, na.rm = TRUE) == 14 ~ "associates",
  max(degreelevel, na.rm = TRUE) == 16 ~ "bachelors",
  max(degreelevel, na.rm = TRUE) == 17 ~ "post-bacc",
  max(degreelevel, na.rm = TRUE) == 18 ~ "masters",
  max(degreelevel, na.rm = TRUE) == 21 ~ "phd",
  is.na(degreelevel) ~ "missing")) %>% distinct(id, highest_degree_from_forprofit)

highest_degree_from_hbcu <- ed %>% separate_rows(degreelevel, sep = "#") %>% 
  select(id, degreelevel, ipeds_unit_id) %>% filter(ipeds_unit_id %in% hbcu) %>% group_by(id) %>% mutate(highest_degree_from_hbcu = case_when(
    max(degreelevel, na.rm = TRUE) == 12 ~ "highschool",
    max(degreelevel, na.rm = TRUE) == 13 ~ "GED/diploma",
    max(degreelevel, na.rm = TRUE) == 14 ~ "associates",
    max(degreelevel, na.rm = TRUE) == 16 ~ "bachelors",
    max(degreelevel, na.rm = TRUE) == 17 ~ "post-bacc",
    max(degreelevel, na.rm = TRUE) == 18 ~ "masters",
    max(degreelevel, na.rm = TRUE) == 21 ~ "phd",
    is.na(degreelevel) ~ "missing")) %>% distinct(id, highest_degree_from_hbcu)


highest_degree_from_forprofit$id <- as.character(highest_degree_from_forprofit$id)
highest_degree_from_hbcu$id <- as.character(highest_degree_from_hbcu$id)

bg_covariates %>% filter(veteran == "veteran") %>% 
  mutate(years_experience = year_entered_civilian_workforce - aligned_start) %>% group_by(years_experience) %>% mutate(count = n()) %>% distinct(years_experience, count) %>%
  ggplot(aes(x = years_experience, y = count)) +
  geom_area()

bg_covariates %>% filter(veteran == "veteran") %>% 
  mutate(years_experience = year_entered_civilian_workforce - aligned_start) %>% summarise(median = median(years_experience, na.rm = TRUE))

all_ids <- bg_covariates$id

# Here we are renaming the major and skills for easier analysis
dataset_all_majors <- all_majors %>% filter(id %in% all_ids) %>% filter(!duplicated(id)) %>%
  rename("health_professions" = "51", "social_sciences" = "45", "business" = "52", "computer" = "11", "public_administration" = "44", "visual_arts" = "50", "engineering_tech" = "15", "biology" = "26", "humanities" = "24", "communication" = "09", "engineering" = "14", "philosophy_religion" = "38", "psychology" = "42", "homeland_security" = "43", "physics" = "40", "family_consumer" = "19", "theology_religion" = "39", "culinary_entertainment" = "12", "language_linguistics" = "16", "mathematics" = "27", "education" = "13", "recreation_kinesiology" = "31", "english" = "23", "cultural_gender" = "05", "law" = "22", "agriculture_veterinary" = "01", "leisure_recreation" = "36", "construction" = "46", "library" = "25", "natural_resource" = "03", "architecture" = "04", "interdisciplinary" = "30", "communication_tech" = "10", "transportation_materials" = "49", "health_residency" = "60", "military_science" = "28", "mechanic_repair" = "47", "science_tech" = "41", "military_tech" = "29") %>% pivot_longer(cols = `health_professions`:`military_tech`) %>% filter(value == 1) %>% distinct(id, "major" = name)
dataset_top_majors <- top_majors %>% filter(id %in% all_ids) %>% filter(!duplicated(id)) %>% select(-"NA") %>%
  rename("health_professions" = "51", "social_sciences" = "45", "business" = "52", "computer" = "11", "public_administration" = "44", "visual_arts" = "50", "engineering_tech" = "15", "biology" = "26", "humanities" = "24", "communication" = "09", "engineering" = "14", "philosophy_religion" = "38", "psychology" = "42", "homeland_security" = "43", "physics" = "40", "family_consumer" = "19", "theology_religion" = "39", "culinary_entertainment" = "12", "language_linguistics" = "16", "mathematics" = "27", "education" = "13", "recreation_kinesiology" = "31", "english" = "23", "cultural_gender" = "05", "law" = "22", "agriculture_veterinary" = "01", "leisure_recreation" = "36", "construction" = "46", "library" = "25", "natural_resource" = "03", "architecture" = "04", "interdisciplinary" = "30", "communication_tech" = "10", "transportation_materials" = "49", "health_residency" = "60", "military_science" = "28", "mechanic_repair" = "47", "science_tech" = "41", "military_tech" = "29") %>% pivot_longer(cols = `health_professions`:`military_tech`) %>% filter(value == 1) %>% distinct(id, "top_major" = name)
dataset_all_skills <- all_skills %>% filter(id %in% all_ids) %>% filter(!duplicated(id)) %>%
  rename("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion") %>% pivot_longer(cols = `information`:`religion`) %>% filter(value == 1) %>% distinct(id, "skill" = name)
dataset_top_skills <- top_skills %>% filter(id %in% all_ids) %>% filter(!duplicated(id)) %>%
  rename("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion") %>% pivot_longer(cols = `information`:`religion`) %>% filter(value == 1) %>% distinct(id, "top_skill" = name)
all_ids <- as.integer(all_ids)

# Here we are filling in data for skills and majors of ids with missing information as NA
ids <- dataset_all_majors$id
missing_all_majors_ids <- as.data.frame(all_ids) %>% rename(id = all_ids) %>% filter(!(id %in% ids)) %>% mutate(major = NA)
dataset_all_majors <- dataset_all_majors %>% rbind(missing_all_majors_ids, fill = TRUE)

ids <- dataset_top_majors$id
missing_top_majors_ids <- as.data.frame(all_ids) %>% rename(id = all_ids) %>% filter(!(id %in% ids)) %>% mutate(top_major = NA)
dataset_top_majors <- dataset_top_majors %>% rbind(missing_top_majors_ids)

ids <- dataset_all_skills$id
missing_all_skills_ids <- as.data.frame(all_ids) %>% rename(id = all_ids) %>% filter(!(id %in% ids)) %>% mutate(skill = NA)
dataset_all_skills <- dataset_all_skills %>% rbind(missing_all_skills_ids, fill = TRUE)

ids <- dataset_top_skills$id
missing_top_skills_ids <- as.data.frame(all_ids) %>% rename(id = all_ids) %>% filter(!(id %in% ids)) %>% mutate(top_skill = NA)
dataset_top_skills <- dataset_top_skills %>% rbind(missing_top_skills_ids)
```

```{r cluster-function, fig.height=15, fig.width=15}
# Here we create the function to cluster sequences. We can input the sequence object to cluster, one of three sequence distance options (coming from the testing_cluster_combos top performers) and the number of clusters

cluster <- function(name, object, sequence_option = "option 1", cluster_number) {
transition_matrix <- seqtrate(object, weighted=FALSE, count=TRUE)
round(transition_matrix,2)
diag(transition_matrix) = 0
round(transition_matrix,2)
rowsum <- apply(transition_matrix, 1, sum)
for(i in 1:nrow(transition_matrix)) {
  for (j in 1:ncol(transition_matrix)){
    transition_matrix[i,j] = transition_matrix[i,j]/rowsum[i]
  }
}
transition_matrix <- round(transition_matrix,2)
cost_matrix <- 2-transition_matrix
round(cost_matrix,2)
diag(cost_matrix) = 0
cost_matrix <- round(cost_matrix,2)

if (sequence_option == "option 1"){
# OPTION 1 : OUR OM SPELL, LOW EXPANSION COST AND LOW WEIGHT
sequencing <- seqdist(object, method = "OMspell", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0, expcost = 0)
}
if (sequence_option == "option 2"){
# OPTION 2 : OUR OM
sequencing <- seqdist(object, method = "OMstran", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0.5)
}
if (sequence_option == "option 3"){
# OPTION 3 : OUR OM, LOW WEIGHT ON ORIGIN
sequencing <- seqdist(object, method = "OMstran", indel = 1, sm = cost_matrix, with.missing = TRUE, otto = 0.01)
}
clusterpam <- wcKMedoids(sequencing, k = cluster_number)
#clusterpam$stats

#clusterpam <- clusterpam$clustering
#clusterpam <- factor(clusterpam)

cluster <- list(sequencing, clusterpam, transition_matrix)
names(cluster) <- c("diss", "cluster", "transition")

assign(name, cluster, envir = .GlobalEnv)
}

# Here we create the function to visualize most of the covariates 
cluster_membership_visualization <- function(variable) {
  all_df <- all_df %>% select(-skill, -major) %>% distinct()
  overall <- all_df %>% filter(!is.na({{ variable }})) %>% mutate(total = n()) %>% group_by(cluster) %>% mutate(overall_cluster_count = n()) %>% group_by({{ variable }}) %>% mutate(overall_covariate_percent = round((n()/total * 100), 2)) %>% distinct({{ variable }}, overall_covariate_percent) %>% mutate(cluster_label = "Overall", cluster_group = "Overall", overall_cluster_percent = .1) %>% rename(cluster_covariate_percent = overall_covariate_percent)
all_df %>% filter(!is.na({{ variable }})) %>% mutate(total = n()) %>% group_by(cluster) %>% mutate(overall_cluster_count = n(), overall_cluster_percent = n()/total) %>% group_by({{ variable }}) %>% mutate(overall_covariate_percent = round((n()/total * 100), 2)) %>% group_by(cluster, {{ variable }}) %>% mutate(cluster_covariate_percent = round((n()/overall_cluster_count * 100), 2)) %>% distinct(cluster, cluster_label, cluster_group, {{ variable }}, cluster_covariate_percent, overall_cluster_percent) %>% rbind(overall) %>%
  ggplot(aes(cluster_covariate_percent, reorder(cluster_label, overall_cluster_percent), fill = factor({{ variable }}))) +
  geom_col(aes(width = overall_cluster_percent*6)) +
  facet_wrap(~ factor(cluster_group, levels = c("Overall", "education", "promotion", "no change", "demotion", "unemployment"), labels = c("Overall" = "Overall", "education" = "Education", "promotion" = "Promotion", "no change" = "No Change", "demotion" = "Demotion", "unemployment" = "Unemployment")), ncol = 1, scales="free") +
  theme(text = element_text(size = 25), legend.position = "bottom") +
  labs(x = "Percent in Cluster", y = "") +
  guides(fill = guide_legend(title.position = "top"))
}

# Here we create the function to visualize the skill and major covariates
cluster_membership_visualization_skillmajor <- function(variable) {
  df <- all_df %>%
  filter(!is.na({{ variable }}), {{ variable }} != "NA") %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, {{ variable }}) %>%
  group_by({{ variable }}) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, {{ variable }}) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct({{ variable }}, cluster_long, cluster_group, cluster_label, percent, variable_percent, variable_total, difference) %>%
  group_by({{ variable }}) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na({{ variable }}))
df <- as.data.frame(df)

ggplot(df, aes(cluster_label, reorder( {{ variable }}, variable_total), fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0, limits = c(-1, 1), oob = squish, name = "Factor of difference \n of variable percent in \n cluster to variable \n percent overall", breaks = c(-1, 0, 1),
labels = c("1/2X or less", "0", "2x or more"))+
  theme_classic()+
  #labs(title = paste0("Cluster membership by ", as.character({{ variable }}))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="bottom", panel.background = element_blank(),
        text = element_text(size = 23),
        legend.key.width = unit(4,"line"),
        plot.margin = unit(c(1,6,1,1), "lines")) +
  facet_grid(~factor(cluster_group, levels = c("Overall", "education", "promotion", "no change", "demotion", "unemployment"), labels = c("Overall" = "Overall", "education" = "Education", "promotion" = "Promotion", "no change" = "No Change", "demotion" = "Demotion", "unemployment" = "Unemployment")), switch = "x", scales = "free_x", space = "free_x") +
  guides(fill = guide_colorbar(title.position = "top")) +
  labs(x = "", y = "") 
}
```

```{r creating-all-clusters, fig.height=10, fig.width=15}
# Here we create the clusters for both veterans and nonveterans using a function from the master_functions script
# We aren't building in any years of experience for nonveterans here
# These sequence objects are what is used in the test of cluster quality metrics

# NO YEARS EXPERIENCE ------------------------------------------------------------------------
# Creating sequence objects for 10, 20, and 30 years
seq.10 <- create_seq_all_fixed("seq.10", 10, left_unemp = FALSE, 0)
seq.20 <- create_seq_all_fixed("seq.20", 20, left_unemp = FALSE, 0)
seq.30 <- create_seq_all_fixed("seq.30", 30, left_unemp = FALSE, 0)

# The sequence option and the number of clusters are chosen from the cluster quality metric test

# Clustering sequnces
seq.10cluster_20 <- cluster("cluster_10", seq.10, sequence_option = "option 1", 20)
seq.20cluster_20 <- cluster("cluster_10", seq.20, sequence_option = "option 2", 20)
seq.30cluster_10 <- cluster("cluster_10", seq.30, sequence_option = "option 2", 10)

# TRANSITION MATRIX
tr <- seqtrate(seq.10)
round(tr, 2)

transition.matrix.df <- as.data.frame(tr)
transition.matrix.df$startState <- row.names(transition.matrix.df)
transition.matrix.df <- melt(transition.matrix.df)
colnames(transition.matrix.df)[colnames(transition.matrix.df) == "variable"] <- "endState"
                                        
ggplot(data = transition.matrix.df, aes(x = factor(endState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), y = factor(startState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), fill = value)) + 
  geom_tile() +    
  geom_text(aes(label=round(value,3)), size = 6) +  
  scale_x_discrete(position = "top") + 
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = "white", high = "#E57200") +
  theme(legend.position="bottom", panel.background = element_blank(),         plot.title = element_text(face = "bold"), text = element_text(size = 23),
        legend.key.width = unit(4,"line")) +  
  labs(fill = "Transition Probability",     
       y = "Current Year",       
       x = "Next Year") +
  guides(fill = guide_colorbar(title.position = "top"))

transition.matrix.df <- as.data.frame(seq.10cluster_20$transition)
transition.matrix.df$startState <- row.names(transition.matrix.df)
transition.matrix.df <- melt(transition.matrix.df)
colnames(transition.matrix.df)[colnames(transition.matrix.df) == "variable"] <- "endState"
                                        
ggplot(data = transition.matrix.df, aes(x = factor(endState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), y = factor(startState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), fill = value)) + 
  geom_tile() +    
  geom_text(aes(label=round(value,3)), size = 6) +  
  scale_x_discrete(position = "top") + 
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = "white", high = "#E57200") +
  theme(legend.position="bottom", panel.background = element_blank(),         plot.title = element_text(face = "bold"), text = element_text(size = 23),
        legend.key.width = unit(4,"line")) +  
  labs(fill = "Transition Probability",    
       y = "Current Job",       
       x = "Next Job") +
  guides(fill = guide_colorbar(title.position = "top"))
```

Final clustering:
- Veterans and nonveterans and all
- 10, 20, 30 years

HIGH PERFORMERS:
10 YEARS: OPT 3 19-20, OPT 2 5, OPT 1 19-20
20 YEARS: OPT 2 6, OPT 2 19-20
30 YEARS: OPT 2 5, OPT 2 19-20

```{r clustering-metrics, fig.height=10, fig.width=15}
# Here we test the quality of clusters to see what combination of sequence_option and number of clusters performs the best for four cluster quality metrics
# A more in depth description of this process is explained in 19_testing_cluster_combos

#seq.10 <- create_seq_all_fixed("seq.10", 10, left_unemp = FALSE)
#seq.20 <- create_seq_all_fixed("seq.20", 20, left_unemp = FALSE)
#seq.30 <- create_seq_all_fixed("seq.30", 30, left_unemp = FALSE)

## TEN YEARS --------------
# Creating transition and cost matrix for sequence object
transition_matrix <- seqtrate(seq.10, weighted=FALSE, count=TRUE)
round(transition_matrix,2)
diag(transition_matrix) = 0
round(transition_matrix,2)
rowsum <- apply(transition_matrix, 1, sum)
for(i in 1:nrow(transition_matrix)) {
  for (j in 1:ncol(transition_matrix)){
    transition_matrix[i,j] = transition_matrix[i,j]/rowsum[i]
  }
}
for(j in 1:ncol(transition_matrix)){
      transition_matrix[7,j] = transition_matrix[7,j] = 0
}
transition_matrix <- round(transition_matrix,2)
cost_matrix <- 2-transition_matrix
round(cost_matrix,2)
diag(cost_matrix) = 0
cost_matrix <- round(cost_matrix,2)

# Creating distance matricies for the three distance options
# OPTION 1 : OUR OM SPELL, LOW EXPANSION COST AND LOW WEIGHT
sequencing.opt1 <- seqdist(seq.10, method = "OMspell", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0, expcost = 0)

# OPTION 2 : OUR OM
sequencing.opt2 <- seqdist(seq.10, method = "OMstran", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0.5)

# OPTION 3 : OUR OM, LOW WEIGHT ON ORIGIN
sequencing.opt3 <- seqdist(seq.10, method = "OMstran", indel = 1, sm = cost_matrix, with.missing = TRUE, otto = 0.01)

# Beginning the clustering, we are only using PAM clustering so we are varying the number of clusters and the distance option here
# CLUSTERING
numbers <- (2:20)
pamstats <- NULL
#rownames(pamstats) <- numbers
pamstats <- NULL
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt1, k = number)
  assign(paste0("sequencing.pam.opt1.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt1 <- dplyr::bind_rows(pamstats)
pamstats <- NULL
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt2, k = number)
  assign(paste0("sequencing.pam.opt2.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt2 <- dplyr::bind_rows(pamstats)
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt3, k = number)
  assign(paste0("sequencing.pam.opt3.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt3 <- dplyr::bind_rows(pamstats)

# Here we are getting the 4 quality metrics for each solution to compare them
# QUALITY METRICS
rownames(pamstats.opt1) <- numbers
PAM.ASW.Opt1 <- as.matrix(pamstats.opt1$ASW)
colnames(PAM.ASW.Opt1) <- c("ASW opt1")
PAM.ASW.Opt2 <- as.matrix(pamstats.opt2$ASW)
colnames(PAM.ASW.Opt2) <- c("ASW opt2")
PAM.ASW.Opt3 <- as.matrix(pamstats.opt3$ASW)
colnames(PAM.ASW.Opt3) <- c("ASW opt3")
PAM.ASW <- bind_cols(PAM.ASW.Opt1, PAM.ASW.Opt2, PAM.ASW.Opt3)
PAM.ASW <- PAM.ASW %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.ASW$rowname <- as.numeric(PAM.ASW$rowname)

rownames(pamstats.opt1) <- numbers
PAM.HC.Opt1 <- as.matrix(pamstats.opt1$HC)
colnames(PAM.HC.Opt1) <- c("HC opt1")
PAM.HC.Opt2 <- as.matrix(pamstats.opt2$HC)
colnames(PAM.HC.Opt2) <- c("HC opt2")
PAM.HC.Opt3 <- as.matrix(pamstats.opt3$HC)
colnames(PAM.HC.Opt3) <- c("HC opt3")
PAM.HC <- bind_cols(PAM.HC.Opt1, PAM.HC.Opt2, PAM.HC.Opt3)
PAM.HC <- PAM.HC %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.HC$rowname <- as.numeric(PAM.HC$rowname)

rownames(pamstats.opt1) <- numbers
PAM.PBC.Opt1 <- as.matrix(pamstats.opt1$PBC)
colnames(PAM.PBC.Opt1) <- c("PBC opt1")
PAM.PBC.Opt2 <- as.matrix(pamstats.opt2$PBC)
colnames(PAM.PBC.Opt2) <- c("PBC opt2")
PAM.PBC.Opt3 <- as.matrix(pamstats.opt3$PBC)
colnames(PAM.PBC.Opt3) <- c("PBC opt3")
PAM.PBC <- bind_cols(PAM.PBC.Opt1, PAM.PBC.Opt2, PAM.PBC.Opt3)
PAM.PBC <- PAM.PBC %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.PBC$rowname <- as.numeric(PAM.PBC$rowname)

rownames(pamstats.opt1) <- numbers
PAM.R2.Opt1 <- as.matrix(pamstats.opt1$R2)
colnames(PAM.R2.Opt1) <- c("R2 opt1")
PAM.R2.Opt2 <- as.matrix(pamstats.opt2$R2)
colnames(PAM.R2.Opt2) <- c("R2 opt2")
PAM.R2.Opt3 <- as.matrix(pamstats.opt3$R2)
colnames(PAM.R2.Opt3) <- c("R2 opt3")
PAM.R2 <- bind_cols(PAM.R2.Opt1, PAM.R2.Opt2, PAM.R2.Opt3)
PAM.R2 <- PAM.R2 %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.R2$rowname <- as.numeric(PAM.R2$rowname)

# Here we visualize the results comparing each cluster solution
PAM.ASW %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "ASW value", type = "viridis") +
#  labs(title = "10 Years - ASW (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
  theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top"))

PAM.HC %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "HC value", type = "viridis") +
 # labs(title = "10 Years - HC (optimal 0)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
  theme(text = element_text(size = 30), ,
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top"))

PAM.PBC %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "PBC value", type = "viridis") +
#  labs(title = "10 Years - PBC (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
  theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line")) +
  guides(fill = guide_colorbar(title.position = "top"))

PAM.R2 %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "R^2 value", type = "viridis") +
#  labs(title = "10 Years - R2 (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
  theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  coord_cartesian(clip = 'off') +
      theme(plot.margin = unit(c(1,3,1,1), "lines")) +
  guides(fill = guide_colorbar(title.position = "top"))

## TWENTY YEARS ---------------------
transition_matrix <- seqtrate(seq.20, weighted=FALSE, count=TRUE)
round(transition_matrix,2)
diag(transition_matrix) = 0
round(transition_matrix,2)
rowsum <- apply(transition_matrix, 1, sum)
for(i in 1:nrow(transition_matrix)) {
  for (j in 1:ncol(transition_matrix)){
    transition_matrix[i,j] = transition_matrix[i,j]/rowsum[i]
  }
}
for(j in 1:ncol(transition_matrix)){
      transition_matrix[7,j] = transition_matrix[7,j] = 0
}
transition_matrix <- round(transition_matrix,2)
cost_matrix <- 2-transition_matrix
round(cost_matrix,2)
diag(cost_matrix) = 0
cost_matrix <- round(cost_matrix,2)

# OPTION 1 : OUR OM SPELL, LOW EXPANSION COST AND LOW WEIGHT
sequencing.opt1 <- seqdist(seq.20, method = "OMspell", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0, expcost = 0)

# OPTION 2 : OUR OM
sequencing.opt2 <- seqdist(seq.20, method = "OMstran", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0.5)

# OPTION 3 : OUR OM, LOW WEIGHT ON ORIGIN
sequencing.opt3 <- seqdist(seq.20, method = "OMstran", indel = 1, sm = cost_matrix, with.missing = TRUE, otto = 0.01)

# CLUSTERING
numbers <- (2:20)
pamstats <- NULL
#rownames(pamstats) <- numbers
pamstats <- NULL
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt1, k = number)
  assign(paste0("sequencing.pam.opt1.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt1 <- dplyr::bind_rows(pamstats)
pamstats <- NULL
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt2, k = number)
  assign(paste0("sequencing.pam.opt2.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt2 <- dplyr::bind_rows(pamstats)
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt3, k = number)
  assign(paste0("sequencing.pam.opt3.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt3 <- dplyr::bind_rows(pamstats)

# QUALITY METRICS
rownames(pamstats.opt1) <- numbers
PAM.ASW.Opt1 <- as.matrix(pamstats.opt1$ASW)
colnames(PAM.ASW.Opt1) <- c("ASW opt1")
PAM.ASW.Opt2 <- as.matrix(pamstats.opt2$ASW)
colnames(PAM.ASW.Opt2) <- c("ASW opt2")
PAM.ASW.Opt3 <- as.matrix(pamstats.opt3$ASW)
colnames(PAM.ASW.Opt3) <- c("ASW opt3")
PAM.ASW <- bind_cols(PAM.ASW.Opt1, PAM.ASW.Opt2, PAM.ASW.Opt3)
PAM.ASW <- PAM.ASW %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.ASW$rowname <- as.numeric(PAM.ASW$rowname)

rownames(pamstats.opt1) <- numbers
PAM.HC.Opt1 <- as.matrix(pamstats.opt1$HC)
colnames(PAM.HC.Opt1) <- c("HC opt1")
PAM.HC.Opt2 <- as.matrix(pamstats.opt2$HC)
colnames(PAM.HC.Opt2) <- c("HC opt2")
PAM.HC.Opt3 <- as.matrix(pamstats.opt3$HC)
colnames(PAM.HC.Opt3) <- c("HC opt3")
PAM.HC <- bind_cols(PAM.HC.Opt1, PAM.HC.Opt2, PAM.HC.Opt3)
PAM.HC <- PAM.HC %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.HC$rowname <- as.numeric(PAM.HC$rowname)

rownames(pamstats.opt1) <- numbers
PAM.PBC.Opt1 <- as.matrix(pamstats.opt1$PBC)
colnames(PAM.PBC.Opt1) <- c("PBC opt1")
PAM.PBC.Opt2 <- as.matrix(pamstats.opt2$PBC)
colnames(PAM.PBC.Opt2) <- c("PBC opt2")
PAM.PBC.Opt3 <- as.matrix(pamstats.opt3$PBC)
colnames(PAM.PBC.Opt3) <- c("PBC opt3")
PAM.PBC <- bind_cols(PAM.PBC.Opt1, PAM.PBC.Opt2, PAM.PBC.Opt3)
PAM.PBC <- PAM.PBC %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.PBC$rowname <- as.numeric(PAM.PBC$rowname)

rownames(pamstats.opt1) <- numbers
PAM.R2.Opt1 <- as.matrix(pamstats.opt1$R2)
colnames(PAM.R2.Opt1) <- c("R2 opt1")
PAM.R2.Opt2 <- as.matrix(pamstats.opt2$R2)
colnames(PAM.R2.Opt2) <- c("R2 opt2")
PAM.R2.Opt3 <- as.matrix(pamstats.opt3$R2)
colnames(PAM.R2.Opt3) <- c("R2 opt3")
PAM.R2 <- bind_cols(PAM.R2.Opt1, PAM.R2.Opt2, PAM.R2.Opt3)
PAM.R2 <- PAM.R2 %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.R2$rowname <- as.numeric(PAM.R2$rowname)

PAM.ASW %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "ASW value", type = "viridis") +
#  labs(title = "20 Years - ASW (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
  theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top"))

PAM.HC %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "HC value", type = "viridis") +
#  labs(title = "20 Years - HC (optimal 0)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
  theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top")) 

PAM.PBC %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "PBC value", type = "viridis") +
#  labs(title = "20 Years - PBC (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
    theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top"))

PAM.R2 %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "R^2 value", type = "viridis") +
#  labs(title = "20 Years - R2 (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
    theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top"))

## THIRTY YEARS -----------------
transition_matrix <- seqtrate(seq.30, weighted=FALSE, count=TRUE)
round(transition_matrix,2)
diag(transition_matrix) = 0
round(transition_matrix,2)
rowsum <- apply(transition_matrix, 1, sum)
for(i in 1:nrow(transition_matrix)) {
  for (j in 1:ncol(transition_matrix)){
    transition_matrix[i,j] = transition_matrix[i,j]/rowsum[i]
  }
}
for(j in 1:ncol(transition_matrix)){
      transition_matrix[7,j] = transition_matrix[7,j] = 0
}
transition_matrix <- round(transition_matrix,2)
cost_matrix <- 2-transition_matrix
round(cost_matrix,2)
diag(cost_matrix) = 0
cost_matrix <- round(cost_matrix,2)

# OPTION 1 : OUR OM SPELL, LOW EXPANSION COST AND LOW WEIGHT
sequencing.opt1 <- seqdist(seq.30, method = "OMspell", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0, expcost = 0)

# OPTION 2 : OUR OM
sequencing.opt2 <- seqdist(seq.30, method = "OMstran", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0.5)

# OPTION 3 : OUR OM, LOW WEIGHT ON ORIGIN
sequencing.opt3 <- seqdist(seq.30, method = "OMstran", indel = 1, sm = cost_matrix, with.missing = TRUE, otto = 0.01)

# CLUSTERING
numbers <- (2:20)
pamstats <- NULL
#rownames(pamstats) <- numbers
pamstats <- NULL
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt1, k = number)
  assign(paste0("sequencing.pam.opt1.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt1 <- dplyr::bind_rows(pamstats)
pamstats <- NULL
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt2, k = number)
  assign(paste0("sequencing.pam.opt2.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt2 <- dplyr::bind_rows(pamstats)
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt3, k = number)
  assign(paste0("sequencing.pam.opt3.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt3 <- dplyr::bind_rows(pamstats)

# QUALITY METRICS
rownames(pamstats.opt1) <- numbers
PAM.ASW.Opt1 <- as.matrix(pamstats.opt1$ASW)
colnames(PAM.ASW.Opt1) <- c("ASW opt1")
PAM.ASW.Opt2 <- as.matrix(pamstats.opt2$ASW)
colnames(PAM.ASW.Opt2) <- c("ASW opt2")
PAM.ASW.Opt3 <- as.matrix(pamstats.opt3$ASW)
colnames(PAM.ASW.Opt3) <- c("ASW opt3")
PAM.ASW <- bind_cols(PAM.ASW.Opt1, PAM.ASW.Opt2, PAM.ASW.Opt3)
PAM.ASW <- PAM.ASW %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.ASW$rowname <- as.numeric(PAM.ASW$rowname)

rownames(pamstats.opt1) <- numbers
PAM.HC.Opt1 <- as.matrix(pamstats.opt1$HC)
colnames(PAM.HC.Opt1) <- c("HC opt1")
PAM.HC.Opt2 <- as.matrix(pamstats.opt2$HC)
colnames(PAM.HC.Opt2) <- c("HC opt2")
PAM.HC.Opt3 <- as.matrix(pamstats.opt3$HC)
colnames(PAM.HC.Opt3) <- c("HC opt3")
PAM.HC <- bind_cols(PAM.HC.Opt1, PAM.HC.Opt2, PAM.HC.Opt3)
PAM.HC <- PAM.HC %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.HC$rowname <- as.numeric(PAM.HC$rowname)

rownames(pamstats.opt1) <- numbers
PAM.PBC.Opt1 <- as.matrix(pamstats.opt1$PBC)
colnames(PAM.PBC.Opt1) <- c("PBC opt1")
PAM.PBC.Opt2 <- as.matrix(pamstats.opt2$PBC)
colnames(PAM.PBC.Opt2) <- c("PBC opt2")
PAM.PBC.Opt3 <- as.matrix(pamstats.opt3$PBC)
colnames(PAM.PBC.Opt3) <- c("PBC opt3")
PAM.PBC <- bind_cols(PAM.PBC.Opt1, PAM.PBC.Opt2, PAM.PBC.Opt3)
PAM.PBC <- PAM.PBC %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.PBC$rowname <- as.numeric(PAM.PBC$rowname)

rownames(pamstats.opt1) <- numbers
PAM.R2.Opt1 <- as.matrix(pamstats.opt1$R2)
colnames(PAM.R2.Opt1) <- c("R2 opt1")
PAM.R2.Opt2 <- as.matrix(pamstats.opt2$R2)
colnames(PAM.R2.Opt2) <- c("R2 opt2")
PAM.R2.Opt3 <- as.matrix(pamstats.opt3$R2)
colnames(PAM.R2.Opt3) <- c("R2 opt3")
PAM.R2 <- bind_cols(PAM.R2.Opt1, PAM.R2.Opt2, PAM.R2.Opt3)
PAM.R2 <- PAM.R2 %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.R2$rowname <- as.numeric(PAM.R2$rowname)

PAM.ASW %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "ASW value", type = "viridis") +
#  labs(title = "30 Years - ASW (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
    theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top"))

PAM.HC %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "HC value", type = "viridis") +
#  labs(title = "30 Years - HC (optimal 0)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
    theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top"))

PAM.PBC %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "PBC value", type = "viridis") +
#  labs(title = "30 Years - PBC (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
    theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top"))

PAM.R2 %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "R^2 value", type = "viridis") +
#  labs(title = "30 Years - R2 (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
#within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "Dissimilarity Option", labels = c("1", "2", "3")) +
  ylab("Number of Clusters") +
  ylim(1,21) +
  theme(text = element_text(size = 30),
        legend.key.width = unit(4,"line"), legend.position = "bottom") +
  guides(fill = guide_colorbar(title.position = "top"))

# Taking notes on the high performers for 10, 20, and 30 years
## HIGH PERFORMERS:
## 10 YEARS: OPT 3 19-20, OPT 2 5, OPT 1 19-20
## 20 YEARS: OPT 2 6, OPT 2 19-20
## 30 YEARS: OPT 5, OPT 2 19-20
```

```{r all-clusters-rep-seq, fig.height=18, fig.width=15}
# Here we are extracting the representative sequence for each cluster and manipulating the data so that it can be plotted using ggplot

## 10 years ----------------------------

cluster_20 <- seq.10cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)

seqrep_plot <- function(cluster_number = "7088", cluster = "Education to Zone 5", cluster_group = "Education") {
output <- seqrep(seq.10[cluster_20_fac== cluster_number ,], group = cluster_20_fac, diss = seq.10cluster_20$diss[cluster_20_fac==cluster_number,cluster_20_fac== cluster_number])
output <- output[1,]
output <- output %>% gather() %>% rename("Year" = "key", "State" = "value") %>% mutate("cluster" = cluster, "cluster_group" = cluster_group, "nseq" = nrow(seq.10[cluster_20_fac == cluster_number,])) }

one <- seqrep_plot(cluster_number = "6776", cluster = "Education to Unemployment to Education", cluster_group = "Education")
two <- seqrep_plot(cluster_number = "7088", cluster = "Education to Zone 5", cluster_group = "Education")
three <- seqrep_plot(cluster_number = "7089", cluster = "Education to Zone 4", cluster_group = "Education")
four <- seqrep_plot(cluster_number = "7138", cluster = "Education to Zone 3", cluster_group = "Education")
five <- seqrep_plot(cluster_number = "7143", cluster = "Education to Unemployment", cluster_group = "Education")
six <- seqrep_plot(cluster_number = "7189", cluster = "Zone 4 to Education to Zone 4", cluster_group = "Education")
seven <- seqrep_plot(cluster_number = "7196", cluster = "Education to Unemployment to Zone 4", cluster_group = "Education")
eight <- seqrep_plot(cluster_number = "9881", cluster = "Zone 4 to Zone 5", cluster_group = "Promotion")
nine <- seqrep_plot(cluster_number = "10037", cluster = "Zone 5", cluster_group = "No Change")
ten <- seqrep_plot(cluster_number = "14833", cluster = "Zone 4 to Unemployment to Zone 4", cluster_group = "Unemployment")
eleven <- seqrep_plot(cluster_number = "14915", cluster = "Zone 4 to Zone 3 to Zone 4", cluster_group = "No Change")
twelve <- seqrep_plot(cluster_number = "14946", cluster = "Zone 2 to Zone 4", cluster_group = "Promotion")
thirteen <- seqrep_plot(cluster_number = "14954", cluster = "Zone 4 to Unemployment", cluster_group = "Unemployment")
fourteen <- seqrep_plot(cluster_number = "14955", cluster = "Zone 3 to Zone 4", cluster_group = "Promotion")
fifteen <- seqrep_plot(cluster_number = "14957", cluster = "Zone 4", cluster_group = "No Change")
sixteen <- seqrep_plot(cluster_number = "15114", cluster = "Zone 2 to Unemployment to Zone 2", cluster_group = "Unemployment")
seventeen <- seqrep_plot(cluster_number = "15790", cluster = "Zone 3 to Unemployment to Zone 3", cluster_group = "Unemployment")
eighteen <- seqrep_plot(cluster_number = "16178", cluster = "Zone 2 to Zone 3", cluster_group = "Promotion")
nineteen <- seqrep_plot(cluster_number = "16193", cluster = "Zone 3", cluster_group = "No Change")
twenty <- seqrep_plot(cluster_number = "16733", cluster = "Zone 2", cluster_group = "No Change")

test <- rbind(one, two, three, four, five, six, seven, eight, nine, ten, eleven, twelve, thirteen, fourteen, fifteen, sixteen, seventeen, eighteen, nineteen, twenty)
test$Year <- as.numeric(test$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:10)) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,6,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 10.5, fill = NA), hjust = 0, size = 6) +
  expand_limits(x = 12) +
  guides(fill = guide_legend(title.position = "top"))

## 20 years ----------------------------

cluster_20 <- seq.20cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)

seqrep_plot <- function(cluster_number = "7088", cluster = "Education to Zone 5", cluster_group = "Education") {
output <- seqrep(seq.20[cluster_20_fac== cluster_number ,], group = cluster_20_fac, diss = seq.20cluster_20$diss[cluster_20_fac==cluster_number,cluster_20_fac== cluster_number])
output <- output[1,]
output <- output %>% gather() %>% rename("Year" = "key", "State" = "value") %>% mutate("cluster" = cluster, "cluster_group" = cluster_group, "nseq" = nrow(seq.20[cluster_20_fac == cluster_number,])) }

one <- seqrep_plot(cluster_number = "60", cluster = "Education to Zone 5", cluster_group = "Education")
two <- seqrep_plot(cluster_number = "95", cluster = "Education to Unemployment to Education to Zone 4", cluster_group = "Education")
three <- seqrep_plot(cluster_number = "299", cluster = "Education to Unemployment to Zone 4", cluster_group = "Education")
four <- seqrep_plot(cluster_number = "1751", cluster = "Education to Zone 3", cluster_group = "Education")
five <- seqrep_plot(cluster_number = "1840", cluster = "Education to Unemployment to Zone 2", cluster_group = "Education")

six <- seqrep_plot(cluster_number = "2627", cluster = "Education to Zone 4 to Education to Zone 4", cluster_group = "Education")
seven <- seqrep_plot(cluster_number = "2787", cluster = "Education to Unemployment", cluster_group = "Education")
eight <- seqrep_plot(cluster_number = "3242", cluster = "Education to Zone 4", cluster_group = "Education")
nine <- seqrep_plot(cluster_number = "3346", cluster = "Zone 4 to Zone 5", cluster_group = "Promotion")
ten <- seqrep_plot(cluster_number = "4584", cluster = "Zone 5 to Zone 4", cluster_group = "Demotion")

eleven <- seqrep_plot(cluster_number = "4630", cluster = "Zone 5", cluster_group = "No Change")
twelve <- seqrep_plot(cluster_number = "5976", cluster = "Zone 2 to Zone 4", cluster_group = "Promotion")
thirteen <- seqrep_plot(cluster_number = "5987", cluster = "Zone 4 to Unemployment to Zone 4", cluster_group = "Unemployment")
fourteen <- seqrep_plot(cluster_number = "6386", cluster = "Zone 4 to Zone 3", cluster_group = "Demotion")
fifteen <- seqrep_plot(cluster_number = "6637", cluster = "Zone 3 to Zone 4", cluster_group = "Promotion")

sixteen <- seqrep_plot(cluster_number = "6650", cluster = "Zone 4", cluster_group = "No Change")
seventeen <- seqrep_plot(cluster_number = "6664", cluster = "Zone 2 to Zone 3", cluster_group = "Promotion")
eighteen <- seqrep_plot(cluster_number = "6718", cluster = "Zone 3 Unemployment", cluster_group = "Unemployment")
nineteen <- seqrep_plot(cluster_number = "7034", cluster = "Zone 3", cluster_group = "No Change")
twenty <- seqrep_plot(cluster_number = "7168", cluster = "Zone 2", cluster_group = "No Change")

test <- rbind(one, two, three, four, five, six, seven, eight, nine, ten, eleven, twelve, thirteen, fourteen, fifteen, sixteen, seventeen, eighteen, nineteen, twenty)
test$Year <- as.numeric(test$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:20), breaks = c(seq(1, 20, by = 2))) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,1,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 20.5, fill = NA), hjust = 0, size = 6) +
  expand_limits(x = 24) +
  guides(fill = guide_legend(title.position = "top"))

## 30 years ----------------------------

cluster_20 <- seq.30cluster_10$cluster$clustering
cluster_20_fac <- factor(cluster_20)

seqrep_plot <- function(cluster_number = "7088", cluster = "Education to Zone 5", cluster_group = "Education") {
output <- seqrep(seq.30[cluster_20_fac== cluster_number ,], group = cluster_20_fac, diss = seq.30cluster_10$diss[cluster_20_fac==cluster_number,cluster_20_fac== cluster_number])
output <- output[1,]
output <- output %>% gather() %>% rename("Year" = "key", "State" = "value") %>% mutate("cluster" = cluster, "cluster_group" = cluster_group, "nseq" = nrow(seq.30[cluster_20_fac == cluster_number,])) }

one <- seqrep_plot(cluster_number = "380", cluster = "Education to Zone 4", cluster_group = "Education")
two <- seqrep_plot(cluster_number = "429", cluster = "Education to Unemployment to Zone 3", cluster_group = "Education")
three <- seqrep_plot(cluster_number = "506", cluster = "Zone 4 to Zone 5", cluster_group = "Promotion")
four <- seqrep_plot(cluster_number = "584", cluster = "Zone 5", cluster_group = "No Change")
five <- seqrep_plot(cluster_number = "880", cluster = "Education to Unemployment to Zone 4", cluster_group = "Education")

six <- seqrep_plot(cluster_number = "1109", cluster = "Education to Unemployment", cluster_group = "Education")
seven <- seqrep_plot(cluster_number = "2089", cluster = "Zone 3 to Zone 4", cluster_group = "Promotion")
eight <- seqrep_plot(cluster_number = "2126", cluster = "Zone 4", cluster_group = "No Change")
nine <- seqrep_plot(cluster_number = "2216", cluster = "Zone 3", cluster_group = "No Change")
ten <- seqrep_plot(cluster_number = "2255", cluster = "Zone 2", cluster_group = "No Change")

test <- rbind(one, two, three, four, five, six, seven, eight, nine, ten)
test$Year <- as.numeric(test$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:30), breaks = c(seq(1, 30, by = 5))) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,1,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 30.5, fill = NA), hjust = 0, size = 6) +
  expand_limits(x = 36) +
  guides(fill = guide_legend(title.position = "top"))
```

```{r variables-table}
data_profiling(bg_covariates)
variables_table <- bg_covariates

variables_table$id <- as.integer(variables_table$id)
variables_table$veteran <- as.factor(variables_table$veteran)
variables_table$gender <- as.factor(variables_table$gender)

#variables_table$irr <- as.integer(variables_table$irr)
variables_table$irr_bin <- as.factor(variables_table$irr_bin)
variables_table$highest_degree <- as.factor(variables_table$highest_degree)
variables_table$officer <- as.factor(variables_table$officer)
variables_table$end_onet55 <- as.factor(variables_table$end_onet55)

variables_table <- variables_table %>% select(id, veteran, gender, zipcode, irr, irr_bin, highest_degree, officer, end_onet55, aligned_start, year_entered_workforce_bin, career_before_military, year_military_enlist, year_military_enlist_bin, year_military_exit, years_in_military, military_transition_unemployment, year_entered_civilian_workforce)

data_profiling <- function(df){
  nrow = nrow(df)
  summary_table <- tibble(var = names(df),
                          variable_type = map_chr(.x = df, .f = function(col) class(x = col)),
                          num_unique = map_int(.x = df, .f = function(col) length(x = unique(x = col))),
                          num_missing = map_int(.x = df, .f = function(col) sum(x = is.na(x = col)))) %>%
    mutate(perc_missing = round(x = 100 * num_missing / nrow, digits = 2L))
  return(summary_table)
}

data_profiling(variables_table)

list(
"Veteran status" = levels(variables_table$veteran),
"Gender" = levels(variables_table$gender),
"IRR" = range(variables_table$irr, na.rm = TRUE),
"IRR Bin" = levels(variables_table$irr_bin),
"Highest degree" = levels(variables_table$highest_degree),
"Oficer" = levels(variables_table$officer),
"Last O*NET-55" = levels(variables_table$end_onet55),
"Year entered workforce" = range(variables_table$aligned_start, na.rm = TRUE),
"Generation" = levels(variables_table$year_entered_workforce_bin))

vet_variables_table <- variables_table %>% filter(veteran == "veteran") %>% filter(years_in_military > 0)
data_profiling(vet_variables_table)
list("Career before military" = range(vet_variables_table$career_before_military, na.rm = TRUE),
"Year of military enlist" = range(vet_variables_table$year_military_enlist, na.rm = TRUE),
"Period of military enlist" = levels(vet_variables_table$year_military_enlist_bin),
"Year of military exit" = range(vet_variables_table$year_military_exit, na.rm = TRUE),
"Years in military" = range(vet_variables_table$years_in_military, na.rm = TRUE),
"Years of military transition unemployment" = range(vet_variables_table$military_transition_unemployment, na.rm = TRUE),
"Year entered civlian workforce" = range(vet_variables_table$year_entered_civilian_workforce, na.rm = TRUE))

round(range(variables_table$irr, na.rm = TRUE), 2)
```


```{r all-clusters-ten-years, fig.height=18, fig.width=18}
# Visualizing 10 years 20 cluster solution --------------------------------------------------
seq.10cluster_20$cluster$stats

cluster_20 <- seq.10cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(6776, 7088, 7089, 7138, 7143, 7189, 7196) ~ "education",
cluster %in% c(9881, 14946, 14955, 16178) ~ "promotion",
#cluster %in% c() ~ "demotion",
cluster %in% c(14833, 14954, 15114, 15790) ~ "unemployment",
cluster %in% c(10037, 14915, 14957, 16193, 16733) ~ "no change"
),
cluster_label = case_when(
  cluster == 6776 ~ "Education to Unemployment to Education",
  cluster == 7088 ~ "Education to Zone 5",
  cluster == 7089 ~ "Education to Zone 4",
  cluster == 7138 ~ "Education to Zone 3",
  cluster == 7143 ~ "Education to Unemployment",
  
  cluster == 7189 ~ "Zone 4 to Education to Zone 4",
  cluster == 7196 ~ "Education to Unemployment to Zone 4",
  cluster == 9881 ~ "Zone 4 to Zone 5",
  cluster == 10037 ~ "Zone 5",
  cluster == 14833 ~ "Zone 4 to Unemployment to Zone 4",
  
  cluster == 14915 ~ "Zone 4 to Zone 3 to Zone 4",
  cluster == 14946 ~ "Zone 2 to Zone 4",
  cluster == 14954 ~ "Zone 4 to Unemployment",
  cluster == 14955 ~ "Zone 3 to Zone 4",
  cluster == 14957 ~ "Zone 4",
  
  cluster == 15114 ~ "Zone 2 to Unemployment to Zone 2",
  cluster == 15790 ~ "Zone 3 to Unemployment to Zone 3",
  cluster == 16178 ~ "Zone 2 to Zone 3",
  cluster == 16193 ~ "Zone 3",
  cluster == 16733 ~ "Zone 2"
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")
#data_profiling(all_df)
all_df <- all_df %>% mutate(
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))

all_df$irr_bin <- as.factor(as.character(all_df$irr_bin)) %>%  fct_collapse(all_df$irr_bin, 
               "Most Urban" = "1",
               "Other" = c("2", "3", "4"),
               "Most Rural" = "5")

seqdplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

seqrplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", diss = seq.10cluster_20$diss, main = "blah", criterion = "freq",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

plot <- cluster_membership_visualization(veteran) 
plot + scale_fill_discrete(labels = c("not veteran" = "Non-Veteran", "veteran" = "Veteran"), name = "Veteran Status")
plot <- cluster_membership_visualization(highest_degree)
plot + scale_fill_discrete(labels = c("High School", "GED/Diploma", "Associates", "Bachelors", "Masters", "PhD"), name = "Highest Degree Earned")
plot <- cluster_membership_visualization(gender)
plot + scale_fill_discrete(labels = c("Male", "Female"), name = "Gender")
plot <- cluster_membership_visualization(irr_bin)
plot + scale_fill_discrete(name = "Relative Rurality")
#plot <- cluster_membership_visualization(highest_degree_from_forprofit)
#plot + scale_fill_discrete(labels = c(), name = "Gender")
#plot <- cluster_membership_visualization(highest_degree_from_hbcu)
#plot + scale_fill_discrete(labels = c(), name = "Gender")
plot <- cluster_membership_visualization(year_entered_workforce_bin)
plot + scale_fill_discrete(labels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial", "Post-Millennial"), name = "Generation cohort \n (by year entered the workforce)") +
  guides(fill = guide_legend(nrow = 2, title.position = "top"))
plot <- cluster_membership_visualization_skillmajor(top_skill)
plot + labs(y = "Top Skill") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion"))
plot <- cluster_membership_visualization_skillmajor(skill)
plot + labs(y = "All Skills") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion"))
plot <- cluster_membership_visualization_skillmajor(top_major)
plot + labs(y = "Top Major (Shorthand)") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("health_professions" = "Health Professions", "social_sciences" = "Social Sciences", "business" = "Business", "computer" = "Computer Science", "public_administration" = "Public Administration", "visual_arts" = "Visual Arts", "engineering_tech" = "Engineering Technologies/Technicians", "biology" = "Biology", "humanities" = "Liberal Arts and Humanities", "communication" = "Communication", "engineering" = "Engineering", "philosophy_religion" = "Philosophy and Religious Studies", "psychology" = "Psychology", "homeland_security" = "Homeland Security", "physics" = "Physics", "family_consumer" = "Family and Consumer Sciences", "theology_religion" = "Theology and Religious Vocations", "culinary_entertainment" = "Culinary and Entertainment Services", "language_linguistics" = "Foreign Languages and Lingustics", "mathematics" = "Mathematics", "education" = "Education", "recreation_kinesiology" = "Parks, Recreation, and Kinesiology", "english" = "English", "cultural_gender" = "Cultural/Gender Studies", "law" = "Legal Studies", "agriculture_veterinary" = "Agricultual/Vetrinary Studies", "leisure_recreation" = "Lesiure and Recreational Activities", "construction" = "Construction", "library" = "Library Science", "natural_resource" = "Natural Resources and Conservation", "architecture" = "Architecture", "interdisciplinary" = "Interdisciplinary Studies", "communication_tech" = "Communication Technologies/Technicians", "transportation_materials" = "Transportation and Materials Moving", "health_residency" = "Health Residency/Fellowship Programs", "military_science" = "Military Science", "mechanic_repair" = "Mechanic and Repair Technologies/Technicians", "science_tech" = "Science Technologies/Technicians", "military_tech" = "Military Technologies"))
plot <- cluster_membership_visualization_skillmajor(major)
plot + labs(y = "All Majors (Shorthand)") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("health_professions" = "Health Professions", "social_sciences" = "Social Sciences", "business" = "Business", "computer" = "Computer Science", "public_administration" = "Public Administration", "visual_arts" = "Visual Arts", "engineering_tech" = "Engineering Technologies/Technicians", "biology" = "Biology", "humanities" = "Liberal Arts and Humanities", "communication" = "Communication", "engineering" = "Engineering", "philosophy_religion" = "Philosophy and Religious Studies", "psychology" = "Psychology", "homeland_security" = "Homeland Security", "physics" = "Physics", "family_consumer" = "Family and Consumer Sciences", "theology_religion" = "Theology and Religious Vocations", "culinary_entertainment" = "Culinary and Entertainment Services", "language_linguistics" = "Foreign Languages and Lingustics", "mathematics" = "Mathematics", "education" = "Education", "recreation_kinesiology" = "Parks, Recreation, and Kinesiology", "english" = "English", "cultural_gender" = "Cultural/Gender Studies", "law" = "Legal Studies", "agriculture_veterinary" = "Agricultual/Vetrinary Studies", "leisure_recreation" = "Lesiure and Recreational Activities", "construction" = "Construction", "library" = "Library Science", "natural_resource" = "Natural Resources and Conservation", "architecture" = "Architecture", "interdisciplinary" = "Interdisciplinary Studies", "communication_tech" = "Communication Technologies/Technicians", "transportation_materials" = "Transportation and Materials Moving", "health_residency" = "Health Residency/Fellowship Programs", "military_science" = "Military Science", "mechanic_repair" = "Mechanic and Repair Technologies/Technicians", "science_tech" = "Science Technologies/Technicians", "military_tech" = "Military Technologies"))

#data_profiling(all_df)

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)
```

```{r all-clusters-twenty-years, fig.height=18, fig.width=22}
# Visualizing 20 years 20 cluster solution --------------------------------------------------
seq.20cluster_20$cluster$stats

cluster_20 <- seq.20cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(60, 95, 299, 1751, 1840, 2627, 2787, 3242) ~ "education",
cluster %in% c(3346, 5976, 6637, 6664) ~ "promotion",
cluster %in% c(4584, 6386) ~ "demotion",
cluster %in% c(5987, 6718) ~ "unemployment",
cluster %in% c(4630, 6650, 7034, 7168) ~ "no change"
),
cluster_label = case_when(
  cluster == 60 ~ "Education to Zone 5",
  cluster == 95 ~ "Education to Zone 4",
  cluster == 299 ~ "Education to Unemployment to Zone 4",
  cluster == 1751 ~ "Education to Unemployment to Zone 3",
  cluster == 1840 ~ "Education to Unemployment to Zone 2",
  
  cluster == 2627 ~ "Education to Zone 4 to Education to Zone 4",
  cluster == 2787 ~ "Education to Unemployment",
  cluster == 3242 ~ "Education to Zone 4",
  cluster == 3346 ~ "Zone 4 to Zone 5",
  cluster == 4584 ~ "Zone 5 to Zone 4",
  
  cluster == 4630 ~ "Zone 5",
  cluster == 5976 ~ "Zone 2 to Zone 4",
  cluster == 5987 ~ "Zone 4 to Unemployment to Zone 4",
  cluster == 6386 ~ "Zone 4 to Zone 3",
  cluster == 6637 ~ "Zone 3 to Zone 4",
  
  cluster == 6650 ~ "Zone 4",
  cluster == 6664 ~ "Zone 2 to Zone 3",
  cluster == 6718 ~ "Zone 3 to Unemployment to Zone 3",
  cluster == 7034 ~ "Zone 3",
  cluster == 7168 ~ "Zone 2"
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")

all_df <- all_df %>% mutate(
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))

seqdplot(seq.20, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))
seqrplot(seq.20, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", diss = seq.20cluster_20$diss,
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

plot <- cluster_membership_visualization(veteran) 
plot + scale_fill_discrete(labels = c("not veteran" = "Non-Veteran", "veteran" = "Veteran"), name = "Veteran Status")
plot <- cluster_membership_visualization(highest_degree)
plot + scale_fill_discrete(labels = c("High School", "GED/Diploma", "Associates", "Bachelors", "Masters", "PhD"), name = "Highest Degree Earned")
plot <- cluster_membership_visualization(gender)
plot + scale_fill_discrete(labels = c("Male", "Female"), name = "Gender")
plot <- cluster_membership_visualization(irr_bin)
plot + scale_fill_discrete(name = "Relative Rurality")
#plot <- cluster_membership_visualization(highest_degree_from_forprofit)
#plot + scale_fill_discrete(labels = c(), name = "Gender")
#plot <- cluster_membership_visualization(highest_degree_from_hbcu)
#plot + scale_fill_discrete(labels = c(), name = "Gender")
plot <- cluster_membership_visualization(year_entered_workforce_bin)
plot + scale_fill_discrete(labels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial", "Post-Millennial"), name = "Generation cohort \n (by year entered the workforce)") +
  guides(fill = guide_legend(nrow = 2, title.position = "top"))
plot <- cluster_membership_visualization_skillmajor(top_skill)
plot + labs(y = "Top Skill") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion"))
plot <- cluster_membership_visualization_skillmajor(skill)
plot + labs(y = "All Skills") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion"))
plot <- cluster_membership_visualization_skillmajor(top_major)
plot + labs(y = "Top Major (Shorthand)") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("health_professions" = "Health Professions", "social_sciences" = "Social Sciences", "business" = "Business", "computer" = "Computer Science", "public_administration" = "Public Administration", "visual_arts" = "Visual Arts", "engineering_tech" = "Engineering Technologies/Technicians", "biology" = "Biology", "humanities" = "Liberal Arts and Humanities", "communication" = "Communication", "engineering" = "Engineering", "philosophy_religion" = "Philosophy and Religious Studies", "psychology" = "Psychology", "homeland_security" = "Homeland Security", "physics" = "Physics", "family_consumer" = "Family and Consumer Sciences", "theology_religion" = "Theology and Religious Vocations", "culinary_entertainment" = "Culinary and Entertainment Services", "language_linguistics" = "Foreign Languages and Lingustics", "mathematics" = "Mathematics", "education" = "Education", "recreation_kinesiology" = "Parks, Recreation, and Kinesiology", "english" = "English", "cultural_gender" = "Cultural/Gender Studies", "law" = "Legal Studies", "agriculture_veterinary" = "Agricultual/Vetrinary Studies", "leisure_recreation" = "Lesiure and Recreational Activities", "construction" = "Construction", "library" = "Library Science", "natural_resource" = "Natural Resources and Conservation", "architecture" = "Architecture", "interdisciplinary" = "Interdisciplinary Studies", "communication_tech" = "Communication Technologies/Technicians", "transportation_materials" = "Transportation and Materials Moving", "health_residency" = "Health Residency/Fellowship Programs", "military_science" = "Military Science", "mechanic_repair" = "Mechanic and Repair Technologies/Technicians", "science_tech" = "Science Technologies/Technicians", "military_tech" = "Military Technologies"))
plot <- cluster_membership_visualization_skillmajor(major)
plot + labs(y = "All Majors (Shorthand)") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("health_professions" = "Health Professions", "social_sciences" = "Social Sciences", "business" = "Business", "computer" = "Computer Science", "public_administration" = "Public Administration", "visual_arts" = "Visual Arts", "engineering_tech" = "Engineering Technologies/Technicians", "biology" = "Biology", "humanities" = "Liberal Arts and Humanities", "communication" = "Communication", "engineering" = "Engineering", "philosophy_religion" = "Philosophy and Religious Studies", "psychology" = "Psychology", "homeland_security" = "Homeland Security", "physics" = "Physics", "family_consumer" = "Family and Consumer Sciences", "theology_religion" = "Theology and Religious Vocations", "culinary_entertainment" = "Culinary and Entertainment Services", "language_linguistics" = "Foreign Languages and Lingustics", "mathematics" = "Mathematics", "education" = "Education", "recreation_kinesiology" = "Parks, Recreation, and Kinesiology", "english" = "English", "cultural_gender" = "Cultural/Gender Studies", "law" = "Legal Studies", "agriculture_veterinary" = "Agricultual/Vetrinary Studies", "leisure_recreation" = "Lesiure and Recreational Activities", "construction" = "Construction", "library" = "Library Science", "natural_resource" = "Natural Resources and Conservation", "architecture" = "Architecture", "interdisciplinary" = "Interdisciplinary Studies", "communication_tech" = "Communication Technologies/Technicians", "transportation_materials" = "Transportation and Materials Moving", "health_residency" = "Health Residency/Fellowship Programs", "military_science" = "Military Science", "mechanic_repair" = "Mechanic and Repair Technologies/Technicians", "science_tech" = "Science Technologies/Technicians", "military_tech" = "Military Technologies"))

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)
```

```{r all-clusters-thirty-years, fig.height=10, fig.width=15}
# Visualizing 30 years 10 cluster solution --------------------------------------------------
seq.30cluster_10$cluster$stats

cluster_20 <- seq.30cluster_10$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(380, 429, 506, 880, 1109) ~ "education",
cluster %in% c(2089) ~ "promotion",
#cluster %in% c() ~ "demotion",
#cluster %in% c() ~ "unemployment",
cluster %in% c(584, 2126, 2216, 2255) ~ "no change"
),
cluster_label = case_when(
  cluster == 380 ~ "education to zone 4",
  cluster == 429 ~ "education to unemployment to zone 3",
  cluster == 506 ~ "education to zone 4 to zone 5",
  cluster == 584 ~ "zone 5",
  cluster == 880 ~ "education to unemployment to zone 4",
  
  cluster == 1109 ~ "education to unemployment",
  cluster == 2089 ~ "zone 3 to zone 4",
  cluster == 2126 ~ "zone 4",
  cluster == 2216 ~ "zone 3",
  cluster == 2255 ~ "zone 2",
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")

all_df <- all_df %>% mutate(
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))

seqdplot(seq.30, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))
seqrplot(seq.30, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", diss = seq.30cluster_10$diss,
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

cluster_membership_visualization(veteran)
cluster_membership_visualization(highest_degree)
cluster_membership_visualization(gender)
cluster_membership_visualization(irr_bin)
cluster_membership_visualization(highest_degree_from_forprofit)
cluster_membership_visualization(highest_degree_from_hbcu)
cluster_membership_visualization(year_entered_workforce_bin)

cluster_membership_visualization_skillmajor(top_skill)
cluster_membership_visualization_skillmajor(top_major)
cluster_membership_visualization_skillmajor(skill)
cluster_membership_visualization_skillmajor(major)

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)
```

```{r creating-all-clusters-yexp, fig.height=10, fig.width=15}
# 15 YEARS EXPERIENCE ------------------------------------------------------------------------
# Creating sequence objects fo 10, 20, and 30 years
seq.10 <- create_seq_all_fixed("seq.10", 10, left_unemp = FALSE, 15)
seq.20 <- create_seq_all_fixed("seq.20", 20, left_unemp = FALSE, 15)
seq.30 <- create_seq_all_fixed("seq.30", 30, left_unemp = FALSE, 15)

# Clustering sequnces
seq.10cluster_20 <- cluster("cluster_10", seq.10, sequence_option = "option 1", 20)
seq.20cluster_20 <- cluster("cluster_10", seq.20, sequence_option = "option 2", 20)
seq.30cluster_10 <- cluster("cluster_10", seq.30, sequence_option = "option 2", 10)

# TRANSITION MATRIX
tr <- seqtrate(seq.10)
round(tr, 2)

transition.matrix.df <- as.data.frame(tr)
transition.matrix.df$startState <- row.names(transition.matrix.df)
transition.matrix.df <- melt(transition.matrix.df)
colnames(transition.matrix.df)[colnames(transition.matrix.df) == "variable"] <- "endState"
                                        
ggplot(data = transition.matrix.df, aes(x = factor(endState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), y = factor(startState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), fill = value)) + 
  geom_tile() +    
  geom_text(aes(label=round(value,3))) +  
  scale_x_discrete(position = "top") + 
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = "white", high = "#E57200") +
  theme(legend.position="bottom", panel.background = element_blank(),         plot.title = element_text(face = "bold")) +  
  labs(fill = "Transition Probability",        
       title = "Year to Year Transition Matrix for Veterans",     
       y = "Current Job",       
       x = "Next Job")

transition.matrix.df <- as.data.frame(seq.10cluster_20$transition)
transition.matrix.df$startState <- row.names(transition.matrix.df)
transition.matrix.df <- melt(transition.matrix.df)
colnames(transition.matrix.df)[colnames(transition.matrix.df) == "variable"] <- "endState"
                                        
ggplot(data = transition.matrix.df, aes(x = factor(endState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), y = factor(startState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), fill = value)) + 
  geom_tile() +    
  geom_text(aes(label=round(value,3))) +  
  scale_x_discrete(position = "top") + 
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = "white", high = "#E57200") +
  theme(legend.position="bottom", panel.background = element_blank(),         plot.title = element_text(face = "bold")) +  
  labs(fill = "Transition Probability",        
       title = "Job to Job Transition Matrix for Veterans",     
       y = "Current Job",       
       x = "Next Job")
```

```{r all-clusters-rep-seq, fig.height=18, fig.width=15}
# Here we are extracting the representative sequence for each cluster and manipulating the data so that it can be plotted using ggplot

## 10 years ----------------------------

cluster_20 <- seq.10cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)

seqrep_plot <- function(cluster_number = "7088", cluster = "Education to Zone 5", cluster_group = "Education") {
output <- seqrep(seq.10[cluster_20_fac== cluster_number ,], group = cluster_20_fac, diss = seq.10cluster_20$diss[cluster_20_fac==cluster_number,cluster_20_fac== cluster_number])
output <- output[1,]
output <- output %>% gather() %>% rename("Year" = "key", "State" = "value") %>% mutate("cluster" = cluster, "cluster_group" = cluster_group, "nseq" = nrow(seq.10[cluster_20_fac == cluster_number,])) }

one <- seqrep_plot(cluster_number = "1470", cluster = "Zone 3 to Education to Zone 3", cluster_group = "Education")
two <- seqrep_plot(cluster_number = "2053", cluster = "Education to Zone 5", cluster_group = "Education")
three <- seqrep_plot(cluster_number = "2107", cluster = "Education to Zone 4", cluster_group = "Education")
four <- seqrep_plot(cluster_number = "2136", cluster = "Zone 4 to Education", cluster_group = "Education")
five <- seqrep_plot(cluster_number = "2154", cluster = "Zone 4 to Education to Zone 4", cluster_group = "Education")

six <- seqrep_plot(cluster_number = "4139", cluster = "Zone 4 to Zone 5 to Zone 4", cluster_group = "No Change")
seven <- seqrep_plot(cluster_number = "4166", cluster = "Zone 5", cluster_group = "No Change")
eight <- seqrep_plot(cluster_number = "4172", cluster = "Zone 5 to Zone 4", cluster_group = "Demotion")
nine <- seqrep_plot(cluster_number = "4183", cluster = "Zone 4 to Zone 5", cluster_group = "Promotion")
ten <- seqrep_plot(cluster_number = "6940", cluster = "Zone 4 to Unemployment to Zone 4", cluster_group = "Unemployment")

eleven <- seqrep_plot(cluster_number = "7114", cluster = "Zone 4 to Unemployment", cluster_group = "Unemployment")
twelve <- seqrep_plot(cluster_number = "7116", cluster = "Zone 4 to Zone 3 to Zone 4", cluster_group = "No Change")
thirteen <- seqrep_plot(cluster_number = "7133", cluster = "Zone 4 to Zone 3", cluster_group = "Demotion")
fourteen <- seqrep_plot(cluster_number = "7140", cluster = "Zone 2 to Zone 4", cluster_group = "Promotion")
fifteen <- seqrep_plot(cluster_number = "7149", cluster = "Zone 3 to Zone 4", cluster_group = "Promotion")

sixteen <- seqrep_plot(cluster_number = "7151", cluster = "Zone 4", cluster_group = "No Change")
seventeen <- seqrep_plot(cluster_number = "7725", cluster = "Zone 3 to Unemployment", cluster_group = "Unemployment")
eighteen <- seqrep_plot(cluster_number = "7746", cluster = "Zone 2 to Zone 3", cluster_group = "Promotion")
nineteen <- seqrep_plot(cluster_number = "7761", cluster = "Zone 3", cluster_group = "No Change")
twenty <- seqrep_plot(cluster_number = "8042", cluster = "Zone 2", cluster_group = "No Change")

test <- rbind(one, two, three, four, five, six, seven, eight, nine, ten, eleven, twelve, thirteen, fourteen, fifteen, sixteen, seventeen, eighteen, nineteen, twenty)
test$Year <- as.numeric(test$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:10)) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,6,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 10.5, fill = NA), hjust = 0, size = 6) +
  expand_limits(x = 12) +
  guides(fill = guide_legend(title.position = "top"))

## 20 years ----------------------------

cluster_20 <- seq.20cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)

seqrep_plot <- function(cluster_number = "7088", cluster = "Education to Zone 5", cluster_group = "Education") {
output <- seqrep(seq.20[cluster_20_fac== cluster_number ,], group = cluster_20_fac, diss = seq.20cluster_20$diss[cluster_20_fac==cluster_number,cluster_20_fac== cluster_number])
output <- output[1,]
output <- output %>% gather() %>% rename("Year" = "key", "State" = "value") %>% mutate("cluster" = cluster, "cluster_group" = cluster_group, "nseq" = nrow(seq.20[cluster_20_fac == cluster_number,])) }

one <- seqrep_plot(cluster_number = "123", cluster = "Zone 3 to Unemp. to Zone 3 to Unemp. to Education", cluster_group = "Education")
two <- seqrep_plot(cluster_number = "303", cluster = "Zone 4 to Education to Zone 4", cluster_group = "Education")
three <- seqrep_plot(cluster_number = "530", cluster = "Zone 5 Education to Zone 5", cluster_group = "Education")
four <- seqrep_plot(cluster_number = "639", cluster = "Education to Zone 4", cluster_group = "Education")
five <- seqrep_plot(cluster_number = "958", cluster = "Zone 5 to Unemployment to Zone 5", cluster_group = "Education")

six <- seqrep_plot(cluster_number = "965", cluster = "Zone 5 to Zone 4", cluster_group = "Demotion")
seven <- seqrep_plot(cluster_number = "1004", cluster = "Zone 4 to Zone 5 (Late)", cluster_group = "Promotion")
eight <- seqrep_plot(cluster_number = "1196", cluster = "Zone 4 to Zone 5 (Early)", cluster_group = "Promotion")
nine <- seqrep_plot(cluster_number = "1452", cluster = "Zone 4 to Zone 5 to Zone 4", cluster_group = "No Change")
ten <- seqrep_plot(cluster_number = "1461", cluster = "Zone 5", cluster_group = "No Change")

eleven <- seqrep_plot(cluster_number = "1541", cluster = "Zone 4 to Zone 3", cluster_group = "Demotion")
twelve <- seqrep_plot(cluster_number = "1598", cluster = "Zone 3 to Zone 4", cluster_group = "Promotion")
thirteen <- seqrep_plot(cluster_number = "1822", cluster = "Zone 4 to Unemployment", cluster_group = "Unemployment")
fourteen <- seqrep_plot(cluster_number = "2172", cluster = "Zone 4 to Zone 2", cluster_group = "Demotion")
fifteen <- seqrep_plot(cluster_number = "2244", cluster = "Zone 2 to Zone 4", cluster_group = "Promotion")

sixteen <- seqrep_plot(cluster_number = "2310", cluster = "Zone 4 to Unemployment to Zone 4", cluster_group = "Unemployment")
seventeen <- seqrep_plot(cluster_number = "2371", cluster = "Zone 4", cluster_group = "No Change")
eighteen <- seqrep_plot(cluster_number = "2381", cluster = "Zone 2 to Zone 3", cluster_group = "Promotion")
nineteen <- seqrep_plot(cluster_number = "2487", cluster = "Zone 3", cluster_group = "No Change")
twenty <- seqrep_plot(cluster_number = "2542", cluster = "Zone 2", cluster_group = "No Change")

test <- rbind(one, two, three, four, five, six, seven, eight, nine, ten, eleven, twelve, thirteen, fourteen, fifteen, sixteen, seventeen, eighteen, nineteen, twenty)
test$Year <- as.numeric(test$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:20), breaks = c(seq(1, 20, by = 2))) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,1,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 20.5, fill = NA), hjust = 0, size = 6) +
  expand_limits(x = 24) +
  guides(fill = guide_legend(title.position = "top"))
```


```{r all-clusters-yexp-ten-years, fig.height=15, fig.width=15}
# Visualizing 10 years 20 cluster solution --------------------------------------------------
seq.10cluster_20$cluster$stats

cluster_20 <- seq.10cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(2053, 2107, 1470, 2136, 2154) ~ "education",
cluster %in% c(4183, 7140, 7149, 7746) ~ "promotion",
cluster %in% c(4172, 7133) ~ "demotion",
cluster %in% c(4166, 6940, 7114, 7725) ~ "unemployment",
cluster %in% c(4139, 7116, 7151, 7761, 8042) ~ "no change"
),
cluster_label = case_when(
  cluster == 2053 ~ "Education to Zone 5",
  cluster == 2107 ~ "Education to Zone 4",
  cluster == 1470 ~ "Zone 3 to Education to Zone 3",
  cluster == 2136 ~ "Zone 4 to Education",
  cluster == 2154 ~ "Zone 4 to Education to Zone 4",
  
  cluster == 4139 ~ "Zone 4 to Zone 5 to Zone 4",
  cluster == 4166 ~ "Zone 5 to Unemployment",
  cluster == 4172 ~ "Zone 5 to Zone 4",
  cluster == 4183 ~ "Zone 4 to Zone 5",
  cluster == 6940 ~ "Zone 4 to Unemployment to Zone 4",
  
  cluster == 7114 ~ "Zone 4 to Unemployment",
  cluster == 7116 ~ "Zone 4 to Zone 3 to Zone 4",
  cluster == 7133 ~ "Zone 4 to Zone 3",
  cluster == 7140 ~ "Zone 2 to Zone 4",
  cluster == 7149 ~ "Zone 3 to Zone 4",
  
  cluster == 7151 ~ "Zone 4",
  cluster == 7725 ~ "Zone 3 to Unemployment",
  cluster == 7746 ~ "Zone 2 to Zone 3",
  cluster == 7761 ~ "Zone 3",
  cluster == 8042 ~ "Zone 2"
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")

all_df <- all_df %>% mutate(
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))

seqdplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))
seqrplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", diss = seq.10cluster_20$diss,
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

plot <- cluster_membership_visualization(veteran) 
plot + scale_fill_discrete(labels = c("not veteran" = "Non-Veteran", "veteran" = "Veteran"), name = "Veteran Status")
cluster_membership_visualization(highest_degree)
cluster_membership_visualization(gender)
cluster_membership_visualization(irr_bin)
cluster_membership_visualization(highest_degree_from_forprofit)
cluster_membership_visualization(highest_degree_from_hbcu)
cluster_membership_visualization(year_entered_workforce_bin)
cluster_membership_visualization_skillmajor(top_skill)
cluster_membership_visualization_skillmajor(top_major)
cluster_membership_visualization_skillmajor(skill)
cluster_membership_visualization_skillmajor(major)

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)
```

```{r all-clusters-yexp-twenty-years, fig.height=10, fig.width=15}
# Visualizing 20 years 20 cluster solution --------------------------------------------------
seq.20cluster_20$cluster$stats

cluster_20 <- seq.20cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(123, 303, 530, 639) ~ "education",
cluster %in% c(1004, 1196, 1598, 2244, 2381) ~ "promotion",
cluster %in% c(965, 1541, 2172, 2487, 2542) ~ "demotion",
cluster %in% c(958, 1822, 2310) ~ "unemployment",
cluster %in% c(1452, 1461, 2371) ~ "no change"
),
cluster_label = case_when(
  cluster == 123 ~ "education to unemployment",
  cluster == 303 ~ "zone 4 to education to zone 4",
  cluster == 530 ~ "education to zone 5",
  cluster == 639 ~ "education to zone 4",
  cluster == 958 ~ "zone 5 to unemployment to zone 5",
  
  cluster == 965 ~ "zone 5 to zone 4",
  cluster == 1004 ~ "zone 4 to zone 5 (Late career)",
  cluster == 1196 ~ "zone 4 to zone 5 (Early career)",
  cluster == 1452 ~ "zone 4 to zone 5 to zone 4",
  cluster == 1461 ~ "zone 5",
  
  cluster == 1541 ~ "zone 4 to zone 3",
  cluster == 1598 ~ "zone 3 to zone 4",
  cluster == 1822 ~ "zone 4 to unemployment",
  cluster == 2172 ~ "zone 4 to zone 2",
  cluster == 2244 ~ "zone 2 to zone 4",
  
  cluster == 2310 ~ "zone 4 to unemployment to zone 4",
  cluster == 2371 ~ "zone 4",
  cluster == 2381 ~ "zone 2 to zone 3",
  cluster == 2487 ~ "zone 4 to zone 3",
  cluster == 2542 ~ "zone 4 to zone 2"
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")

all_df <- all_df %>% mutate(
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))

seqdplot(seq.20, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))
seqrplot(seq.20, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", diss = seq.20cluster_20$diss,
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

cluster_membership_visualization(veteran)
cluster_membership_visualization(highest_degree)
cluster_membership_visualization(gender)
cluster_membership_visualization(irr_bin)
cluster_membership_visualization(highest_degree_from_forprofit)
cluster_membership_visualization(highest_degree_from_hbcu)
cluster_membership_visualization(year_entered_workforce_bin)
cluster_membership_visualization_skillmajor(top_skill)
cluster_membership_visualization_skillmajor(top_major)
cluster_membership_visualization_skillmajor(skill)
cluster_membership_visualization_skillmajor(major)

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)
```

```{r all-clusters-cohort, fig.height=10, fig.width=15, eval = FALSE}
# APPROXIMATE AGE ---------------------------------------------------------------
# Cohort clustering whole career ------------------------------------------------
seq.10 <- create_seq_all_cohort("seq.10", 2000, 2005, after_military = FALSE, left_unemp = FALSE)
seq.10cluster_20 <- cluster("cluster_10", seq.10, sequence_option = "option 1", 20)

cluster_20 <- seq.10cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(2791, 6868, 6884, 6885, 6888) ~ "education",
cluster %in% c(8748, 14400, 14430, 16736) ~ "promotion",
cluster %in% c(8741, 14409, 14414) ~ "demotion",
cluster %in% c(14053) ~ "unemployment",
cluster %in% c(2830, 2831, 6883, 8743, 14435, 16744, 18571) ~ "no change"
),
cluster_label = case_when(
  cluster == 2791 ~ "education to military",
  cluster == 2809 ~ "military",
  cluster == 2830 ~ "military to zone 4",
  cluster == 2831 ~ "education to zone 4",
  cluster == 6862 ~ "zone 4 to education to military/zone 2",
  cluster == 6885 ~ "education to zone 3",
  cluster == 6887 ~ "education to zone 2",
  cluster == 6895 ~ "education to zone 5",
  cluster == 6897 ~ "zone 5 to zone 4",
  cluster == 8763 ~ "zone 5",
  cluster == 8764 ~ "zone 4 to zone 5",
  cluster == 8765 ~ "unemployment to zone 4",
  cluster == 14495 ~ "zone 2 to zone 4",
  cluster == 14510 ~ "zone 4 to zone 3",
  cluster == 14513 ~ "zone 4 to zone 2",
  cluster == 14519 ~ "zone 3 to zone 4",
  cluster == 14520 ~ "zone 4",
  cluster == 16825 ~ "zone 2 to zone 3",
  cluster == 16834 ~ "zone 3",
  cluster == 18637 ~ "zone 2"
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")


all_df <- all_df %>% mutate(
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))

seq.10 <- seq.10[,1:20]
seqdplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", axes = c(1,20), 
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "red", "#CBBEB5"))
seqrplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", diss = seq.10cluster_20$diss,
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "red", "#CBBEB5"))

cluster_membership_visualization(veteran)
cluster_membership_visualization(highest_degree)
cluster_membership_visualization(gender)
cluster_membership_visualization(irr_bin)
cluster_membership_visualization(highest_degree_from_forprofit)
cluster_membership_visualization(highest_degree_from_hbcu)
cluster_membership_visualization(year_entered_workforce_bin)
cluster_membership_visualization_skillmajor(top_skill)
cluster_membership_visualization_skillmajor(top_major)
cluster_membership_visualization_skillmajor(skill)
cluster_membership_visualization_skillmajor(major)

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)
```

```{r all-clusters-five-years-exp, fig.height=10, fig.width=15, eval = FALSE}
# Filtering for five years of experience and careers of 10 years ----------------------------------
seq.10 <- create_seq_all_fixed_experience("seq.10", 10, left_unemp = FALSE, 5)
seq.10cluster_20 <- cluster("cluster_10", seq.10, sequence_option = "option 1", 20)

cluster_20 <- seq.10cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(3140, 3148, 3191, 3212) ~ "education",
cluster %in% c(5016, 8681, 8684, 9682) ~ "promotion",
cluster %in% c(5053, 8641) ~ "demotion",
cluster %in% c(8523, 8670, 9664, 10161) ~ "unemployment",
cluster %in% c(5074, 5078, 8310, 8675, 9682, 10156) ~ "no change"
),
cluster_label = case_when(
  cluster == 3140 ~ "education to zone 4",
  cluster == 3148 ~ "education to unemployment",
  cluster == 3191 ~ "zone 4 to education to zone 4",
  cluster == 3212 ~ "education to zone 5",
  cluster == 5016 ~ "zone 4 to zone 5",
  cluster == 5053 ~ "zone 5 to zone 4",
  cluster == 5074 ~ "zone 5",
  cluster == 5078 ~ "zone 4 to zone 5 to zone 4",
  cluster == 8310 ~ "zone 4",
  cluster == 8523 ~ "zone 4 to unemployment to zone 4",
  cluster == 8641 ~ "zone 4 to zone 3",
  cluster == 8670 ~ "zone 4 to unemployment",
  cluster == 8675 ~ "zone 4 to zone 3 to zone 4",
  cluster == 8681 ~ "zone 2 to zone 4",
  cluster == 8684 ~ "zone 3 to zone 4",
  cluster == 9664 ~ "zone 3 to unemployment to zone 3",
  cluster == 9682 ~ "zone 2 to zone 3",
  cluster == 9698 ~ "zone 3",
  cluster == 10156 ~ "zone 2",
  cluster == 10161 ~ "zone 2 to unemployment to zone 2",
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")

all_df <- all_df %>% mutate(
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))

seqdplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", axes = c(1,20), 
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))
seqrplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", diss = seq.10cluster_20$diss,
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

cluster_membership_visualization(veteran)
cluster_membership_visualization(highest_degree)
cluster_membership_visualization(gender)
cluster_membership_visualization(irr_bin)
cluster_membership_visualization(highest_degree_from_forprofit)
cluster_membership_visualization(highest_degree_from_hbcu)
cluster_membership_visualization(year_entered_workforce_bin)
cluster_membership_visualization_skillmajor(top_skill)
cluster_membership_visualization_skillmajor(top_major)
cluster_membership_visualization_skillmajor(skill)
cluster_membership_visualization_skillmajor(major)

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)
```

```{r creating-veteran-clusters, fig.height=10, fig.width=15}
# VETERANS -----------------------------------------------------------------------------
# Creating sequence objects for 10, 20, and 30 years after exiting the military for veterans 
seq.10 <- create_seq_vet_fixed("seq.10", 10, left_unemp = FALSE)
seq.20 <- create_seq_vet_fixed("seq.20", 20, left_unemp = FALSE)
seq.30 <- create_seq_vet_fixed("seq.30", 30, left_unemp = FALSE)

# Clustering sequnces
seq.10cluster_20 <- cluster("cluster_10", seq.10, sequence_option = "option 1", 20)
seq.20cluster_20 <- cluster("cluster_10", seq.20, sequence_option = "option 2", 20)
seq.30cluster_10 <- cluster("cluster_10", seq.30, sequence_option = "option 2", 10)

# TRANSITION MATRIX
tr <- seqtrate(seq.10)
round(tr, 2)

transition.matrix.df <- as.data.frame(tr)
transition.matrix.df$startState <- row.names(transition.matrix.df)
transition.matrix.df <- melt(transition.matrix.df)
colnames(transition.matrix.df)[colnames(transition.matrix.df) == "variable"] <- "endState"
                                        
ggplot(data = transition.matrix.df, aes(x = factor(endState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), y = factor(startState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), fill = value)) + 
  geom_tile() +    
  geom_text(aes(label=round(value,3)), size = 6) +  
  scale_x_discrete(position = "top") + 
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = "white", high = "#E57200") +
  theme(legend.position="bottom", panel.background = element_blank(),       
        plot.title = element_text(face = "bold"), text = element_text(size = 23),
        legend.key.width = unit(4,"line")) +  
  labs(fill = "Transition Probability",    
       y = "Current Year",       
       x = "Next Year") +
  guides(fill = guide_colorbar(title.position = "top"))

transition.matrix.df <- as.data.frame(seq.10cluster_20$transition)
transition.matrix.df$startState <- row.names(transition.matrix.df)
transition.matrix.df <- melt(transition.matrix.df)
colnames(transition.matrix.df)[colnames(transition.matrix.df) == "variable"] <- "endState"
                                        
ggplot(data = transition.matrix.df, aes(x = factor(endState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), y = factor(startState, labels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5", "Education", "Unemployment")), fill = value)) + 
  geom_tile() +    
  geom_text(aes(label=round(value,3)), size = 6) +  
  scale_x_discrete(position = "top") + 
  scale_y_discrete(limits = rev) +
  scale_fill_gradient(low = "white", high = "#E57200") +
  theme(legend.position="bottom", panel.background = element_blank(),       
        plot.title = element_text(face = "bold"), text = element_text(size = 23),
        legend.key.width = unit(4,"line")) +  
  labs(fill = "Transition Probability",    
       y = "Current Job",       
       x = "Next Job") +
  guides(fill = guide_colorbar(title.position = "top"))
```

```{r vet-clusters-rep-seq, fig.height=15, fig.width=10}
## 10 years ----------------------------

cluster_20 <- seq.10cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)

seqrep_plot <- function(cluster_number = "7088", cluster = "Education to Zone 5", cluster_group = "Education") {
output <- seqrep(seq.10[cluster_20_fac== cluster_number ,], group = cluster_20_fac, diss = seq.10cluster_20$diss[cluster_20_fac==cluster_number,cluster_20_fac== cluster_number])
output <- output[1,]
output <- output %>% gather() %>% rename("Year" = "key", "State" = "value") %>% mutate("cluster" = cluster, "cluster_group" = cluster_group, "nseq" = nrow(seq.10[cluster_20_fac == cluster_number,])) }

one <- seqrep_plot(cluster_number = "933", cluster = "Zone 5 to Education to Zone 5", cluster_group = "Education")
two <- seqrep_plot(cluster_number = "1500", cluster = "Zone 4 to Education to Zone 4", cluster_group = "Education")
three <- seqrep_plot(cluster_number = "1336", cluster = "Education to Zone 4", cluster_group = "Education")
four <- seqrep_plot(cluster_number = "1511", cluster = "Zone 4 to Education", cluster_group = "Education")
five <- seqrep_plot(cluster_number = "2607", cluster = "Zone 4 to Zone 5", cluster_group = "Promotion")
six <- seqrep_plot(cluster_number = "2727", cluster = "Zone 4 to Unemployment to Zone 5", cluster_group = "Unemployment")
seven <- seqrep_plot(cluster_number = "2763", cluster = "Zone 5", cluster_group = "No Change")
eight <- seqrep_plot(cluster_number = "2769", cluster = "Zone 5 to Zone 4", cluster_group = "Demotion")
nine <- seqrep_plot(cluster_number = "2772", cluster = "Zone 4 to Zone 5 to Zone 4", cluster_group = "No Change")
ten <- seqrep_plot(cluster_number = "4169", cluster = "Zone 4 to Zone 3 to Zone 4", cluster_group = "No Change")
eleven <- seqrep_plot(cluster_number = "4303", cluster = "Zone 4 to Unemployment to Zone 4", cluster_group = "Unemployment")
twelve <- seqrep_plot(cluster_number = "4345", cluster = "Zone 3 to Zone 4", cluster_group = "Promotion")
thirteen <- seqrep_plot(cluster_number = "4390", cluster = "Zone 4 to Unemployment", cluster_group = "Unemployment")
fourteen <- seqrep_plot(cluster_number = "4409", cluster = "Zone 4 to Zone 3", cluster_group = "Demotion")
fifteen <- seqrep_plot(cluster_number = "4416", cluster = "Zone 2 to Zone 4", cluster_group = "Promotion")
sixteen <- seqrep_plot(cluster_number = "4427", cluster = "Zone 4", cluster_group = "No Change")
seventeen <- seqrep_plot(cluster_number = "4684", cluster = "Zone 3 to Unemployment", cluster_group = "Unemployment")
eighteen <- seqrep_plot(cluster_number = "4690", cluster = "Zone 2 to Zone 3", cluster_group = "Promotion")
nineteen <- seqrep_plot(cluster_number = "4705", cluster = "Zone 3", cluster_group = "No Change")
twenty <- seqrep_plot(cluster_number = "4830", cluster = "Zone 2", cluster_group = "No Change")

test <- rbind(one, two, three, four, five, six, seven, eight, nine, ten, eleven, twelve, thirteen, fourteen, fifteen, sixteen, seventeen, eighteen, nineteen, twenty)
test$Year <- as.numeric(test$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:10)) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,6,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 10.5, fill = NA), hjust = 0, size = 6) +
  expand_limits(x = 12) +
  guides(fill = guide_legend(title.position = "top"))

labs <- data.frame("Zone 5 to Education to Zone 5", "Education", 2, "Z5", "black") %>% 
rbind(c("Zone 5 to Education to Zone 5", "Education", 5, "EDU", "black")) %>%
rbind(c("Zone 5 to Education to Zone 5", "Education", 8.5, "Z5", "black")) %>%
rbind(c("Zone 4 to Education to Zone 4", "Education", 1, "Z4", "black")) %>%
rbind(c("Zone 4 to Education to Zone 4", "Education", 4, "EDU", "black")) %>%
rbind(c("Zone 4 to Education to Zone 4", "Education", 8.5, "Z4", "black")) %>%
rbind(c("Education to Zone 4", "Education", 2, "Z4", "black")) %>%
rbind(c("Education to Zone 4", "Education", 7, "EDU", "black")) %>%
rbind(c("Zone 4 to Education", "Education", 3.5, "Z4", "black")) %>%
rbind(c("Zone 4 to Education", "Education", 8.5, "EDU", "black")) %>%
rbind(c("Zone 4 to Zone 5", "Promotion", 5, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 5", "Promotion", 10, "Z5", "black")) %>%
rbind(c("Zone 4 to Unemployment to Zone 5", "Unemployment", 2, "Z4", "black")) %>%
rbind(c("Zone 4 to Unemployment to Zone 5", "Unemployment", 6, "UNE", "black")) %>%
rbind(c("Zone 4 to Unemployment to Zone 5", "Unemployment", 9.5, "Z5", "black")) %>%
rbind(c("Zone 5", "No Change", 5.5, "Z5", "black")) %>%
rbind(c("Zone 5 to Zone 4", "Demotion", 5, "Z5", "black")) %>%
rbind(c("Zone 5 to Zone 4", "Demotion", 10, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 5 to Zone 4", "No Change", 4, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 5 to Zone 4", "No Change", 8.5, "Z5", "black")) %>%
rbind(c("Zone 4 to Zone 5 to Zone 4", "No Change", 10, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 3 to Zone 4", "No Change", 4.5, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 3 to Zone 4", "No Change", 9, "Z3", "white")) %>%
rbind(c("Zone 4 to Zone 3 to Zone 4", "No Change", 10, "Z4", "black")) %>%
rbind(c("Zone 4 to Unemployment to Zone 4", "Unemployment", 3, "Z4", "black")) %>%
rbind(c("Zone 4 to Unemployment to Zone 4", "Unemployment", 6.5, "UNE", "black")) %>%
rbind(c("Zone 4 to Unemployment to Zone 4", "Unemployment", 9, "Z4", "black")) %>%
rbind(c("Zone 3 to Zone 4", "Promotion", 1.5, "Z3", "white")) %>%
rbind(c("Zone 3 to Zone 4", "Promotion", 6.5, "Z4", "black")) %>%
rbind(c("Zone 4 to Unemployment", "Unemployment", 4, "Z4", "black")) %>%
rbind(c("Zone 4 to Unemployment", "Unemployment", 9, "UNE", "black")) %>%
rbind(c("Zone 4 to Zone 3", "Demotion", 2, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 3", "Demotion", 7, "Z3", "white")) %>%
rbind(c("Zone 2 to Zone 4", "Promotion", 2.5, "Z2", "white")) %>%
rbind(c("Zone 2 to Zone 4", "Promotion", 7.5, "Z4", "black")) %>%
rbind(c("Zone 4", "No Change", 5.5, "Z4", "black")) %>%
rbind(c("Zone 3 to Unemployment", "Unemployment", 2.5, "Z3", "white")) %>%
rbind(c("Zone 3 to Unemployment", "Unemployment", 7.5, "UNE", "black")) %>%
rbind(c("Zone 2 to Zone 3", "Promotion", 3.5, "Z2", "white")) %>%
rbind(c("Zone 2 to Zone 3", "Promotion", 8.5, "Z3", "white")) %>%
rbind(c("Zone 3", "No Change", 5.5, "Z3", "white")) %>%
rbind(c("Zone 2", "No Change", 5.5, "Z2", "white"))

colnames(labs) <- c("cluster", "cluster_group", "Year", "label", "label_color")
labs$Year <- as.numeric(labs$Year)

test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:10)) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,6,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 10.5, fill = NA), hjust = 0, size = 6) +
  geom_text(data = labs, aes(label = label, y = cluster, x = Year, color = label_color, fill = NA), size = 8) + scale_color_manual(values = c("white" = "white", "black" = "black"), guide = FALSE) +
  expand_limits(x = 12) +
  guides(fill = guide_legend(title.position = "top")) + 
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank(),
         axis.ticks.y = element_blank())

## 20 years ----------------------------

cluster_20 <- seq.20cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)

seqrep_plot <- function(cluster_number = "7088", cluster = "Education to Zone 5", cluster_group = "Education") {
output <- seqrep(seq.20[cluster_20_fac== cluster_number ,], group = cluster_20_fac, diss = seq.20cluster_20$diss[cluster_20_fac==cluster_number,cluster_20_fac== cluster_number])
output <- output[1,]
output <- output %>% gather() %>% rename("Year" = "key", "State" = "value") %>% mutate("cluster" = cluster, "cluster_group" = cluster_group, "nseq" = nrow(seq.20[cluster_20_fac == cluster_number,])) }

one <- seqrep_plot(cluster_number = "91", cluster = "Zone 5 to Ed. to Zone 5 to Unemp. to Zone 2 to Unemp.", cluster_group = "Education")
two <- seqrep_plot(cluster_number = "163", cluster = "Zone 4 to Education to Zone 4", cluster_group = "Education")
three <- seqrep_plot(cluster_number = "343", cluster = "Education to Zone 5", cluster_group = "Education")
four <- seqrep_plot(cluster_number = "452", cluster = "Education to Zone 4", cluster_group = "Education")
five <- seqrep_plot(cluster_number = "576", cluster = "Zone 5 to Zone 4", cluster_group = "Demotion")

six <- seqrep_plot(cluster_number = "628", cluster = "Zone 4 to Zone 5", cluster_group = "Promotion")
seven <- seqrep_plot(cluster_number = "668", cluster = "Zone 5 to Unemp. to Zone 3 to Zone 5 to Unemp. to Zone 5", cluster_group = "Unemployment")
eight <- seqrep_plot(cluster_number = "1018", cluster = "Zone 4 to Education to Zone 4 2", cluster_group = "No Change")
nine <- seqrep_plot(cluster_number = "1020", cluster = "Zone 4 to Zone 5 2", cluster_group = "Promotion")
ten <- seqrep_plot(cluster_number = "1027", cluster = "Zone 5", cluster_group = "No Change")

eleven <- seqrep_plot(cluster_number = "1071", cluster = "Zone 3 to Zone 4 (Early)", cluster_group = "Promotion")
twelve <- seqrep_plot(cluster_number = "1078", cluster = "Zone 4 (Long) to Unemp. to Zone 4", cluster_group = "Unemployment")
thirteen <- seqrep_plot(cluster_number = "1348", cluster = "Zone 3 to Zone 4 (Late)", cluster_group = "Promotion")
fourteen <- seqrep_plot(cluster_number = "1363", cluster = "Zone 4 to Zone 3", cluster_group = "Demotion")
fifteen <- seqrep_plot(cluster_number = "1428", cluster = "Zone 4 to Zone 2", cluster_group = "Demotion")

sixteen <- seqrep_plot(cluster_number = "1566", cluster = "Zone 4 (Short) to Unemp. to Zone 4", cluster_group = "Unemployment")
seventeen <- seqrep_plot(cluster_number = "1627", cluster = "Zone 4", cluster_group = "No Change")
eighteen <- seqrep_plot(cluster_number = "1643", cluster = "Zone 2 to Unemp. to Ed. to Unemp. to Ed. to Zone 3", cluster_group = "Education")
nineteen <- seqrep_plot(cluster_number = "1690", cluster = "Zone 3", cluster_group = "No Change")
twenty <- seqrep_plot(cluster_number = "1720", cluster = "Zone 2", cluster_group = "No Change")

test <- rbind(one, two, three, four, five, six, seven, eight, nine, ten, eleven, twelve, thirteen, fourteen, fifteen, sixteen, seventeen, eighteen, nineteen, twenty)
test$Year <- as.numeric(test$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:20), breaks = c(seq(1, 20, by = 2))) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,1,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 20.5, fill = NA), hjust = 0, size = 6) +
  expand_limits(x = 24) +
  guides(fill = guide_legend(title.position = "top"))

labs <- data.frame("Zone 4 to Education to Zone 4", "Education", 5, "Z4", "black") %>% 
rbind(c("Zone 4 to Education to Zone 4", "Education", 12, "EDU", "black")) %>%
rbind(c("Zone 4 to Education to Zone 4", "Education", 18, "Z4", "black")) %>%

rbind(c("Education to Zone 4", "Education", 1, "Z4", "black")) %>%
rbind(c("Education to Zone 4", "Education", 3, "EDU", "black")) %>%
rbind(c("Education to Zone 4", "Education", 12, "Z4", "black")) %>%
  
rbind(c("Zone 4 to Education to Zone 4 2", "No Change", 5, "Z4", "black")) %>%
rbind(c("Zone 4 to Education to Zone 4 2", "No Change", 11.5, "Z5", "black")) %>%
rbind(c("Zone 4 to Education to Zone 4 2", "No Change", 17, "Z4", "black")) %>%  
  
rbind(c("Education to Zone 5", "Education", 1.5, "Z2", "white")) %>%
rbind(c("Education to Zone 5", "Education", 5, "EDU", "black")) %>%
rbind(c("Education to Zone 5", "Education", 15, "Z5", "black")) %>%
  
rbind(c("Zone 2 to Unemp. to Ed. to Unemp. to Ed. to Zone 3", "Education", 1, "Z2", "white")) %>%
rbind(c("Zone 2 to Unemp. to Ed. to Unemp. to Ed. to Zone 3", "Education", 2, "UNE", "black")) %>%
rbind(c("Zone 2 to Unemp. to Ed. to Unemp. to Ed. to Zone 3", "Education", 4, "EDU", "black")) %>%
rbind(c("Zone 2 to Unemp. to Ed. to Unemp. to Ed. to Zone 3", "Education", 6, "UNE", "black")) %>%
rbind(c("Zone 2 to Unemp. to Ed. to Unemp. to Ed. to Zone 3", "Education", 9, "EDU", "black")) %>%
rbind(c("Zone 2 to Unemp. to Ed. to Unemp. to Ed. to Zone 3", "Education", 16, "Z3", "white")) %>%
  
rbind(c("Zone 5 to Ed. to Zone 5 to Unemp. to Zone 2 to Unemp.", "Education", 2.5, "Z5", "black")) %>%
rbind(c("Zone 5 to Ed. to Zone 5 to Unemp. to Zone 2 to Unemp.", "Education", 7, "EDU", "black")) %>%
rbind(c("Zone 5 to Ed. to Zone 5 to Unemp. to Zone 2 to Unemp.", "Education", 10.5, "Z5", "black")) %>%
rbind(c("Zone 5 to Ed. to Zone 5 to Unemp. to Zone 2 to Unemp.", "Education", 13, "UNE", "black")) %>%
rbind(c("Zone 5 to Ed. to Zone 5 to Unemp. to Zone 2 to Unemp.", "Education", 15.5, "Z2", "white")) %>%
rbind(c("Zone 5 to Ed. to Zone 5 to Unemp. to Zone 2 to Unemp.", "Education", 18.5, "UNE", "black")) %>%
  
rbind(c("Zone 4 to Zone 5", "Promotion", 3, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 5", "Promotion", 14, "Z5", "black")) %>%

rbind(c("Zone 4 to Zone 5 2", "Promotion", 7, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 5 2", "Promotion", 17, "Z5", "black")) %>%
  
rbind(c("Zone 3 to Zone 4 (Late)", "Promotion", 6, "Z3", "white")) %>%
rbind(c("Zone 3 to Zone 4 (Late)", "Promotion", 16, "Z4", "black")) %>%
  
rbind(c("Zone 3 to Zone 4 (Early)", "Promotion", 2, "Z3", "white")) %>%
rbind(c("Zone 3 to Zone 4 (Early)", "Promotion", 12, "Z4", "black")) %>%
  
rbind(c("Zone 4", "No Change", 11, "Z4", "black")) %>%

rbind(c("Zone 3", "No Change", 11, "Z3", "white")) %>%

rbind(c("Zone 2", "No Change", 11, "Z2", "white")) %>%

rbind(c("Zone 5", "No Change", 11, "Z5", "black")) %>%

rbind(c("Zone 5 to Zone 4", "Demotion", 3.5, "Z5", "black")) %>%
rbind(c("Zone 5 to Zone 4", "Demotion", 14, "Z4", "black")) %>%
  
rbind(c("Zone 4 to Zone 3", "Demotion", 6, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 3", "Demotion", 16, "Z3", "white")) %>%
  
rbind(c("Zone 4 to Zone 2", "Demotion", 5, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 2", "Demotion", 16, "Z3", "white")) %>%

rbind(c("Zone 4 (Short) to Unemp. to Zone 4", "Unemployment", 1.5, "Z4", "black")) %>%
rbind(c("Zone 4 (Short) to Unemp. to Zone 4", "Unemployment", 6, "UNE", "black")) %>%
rbind(c("Zone 4 (Short) to Unemp. to Zone 4", "Unemployment", 15, "Z4", "black")) %>%
  
rbind(c("Zone 4 (Long) to Unemp. to Zone 4", "Unemployment", 6, "Z4", "black")) %>%
rbind(c("Zone 4 (Long) to Unemp. to Zone 4", "Unemployment", 16, "UNE", "black")) %>%
rbind(c("Zone 4 (Long) to Unemp. to Zone 4", "Unemployment", 20, "Z4", "black")) %>%
  
rbind(c("Zone 5 to Unemp. to Zone 3 to Zone 5 to Unemp. to Zone 5", "Unemployment", 2, "Z5", "black")) %>%
rbind(c("Zone 5 to Unemp. to Zone 3 to Zone 5 to Unemp. to Zone 5", "Unemployment", 8, "UNE", "black")) %>%
rbind(c("Zone 5 to Unemp. to Zone 3 to Zone 5 to Unemp. to Zone 5", "Unemployment", 12.5, "Z3", "white")) %>%
rbind(c("Zone 5 to Unemp. to Zone 3 to Zone 5 to Unemp. to Zone 5", "Unemployment", 15.5, "Z5", "black")) %>%
rbind(c("Zone 5 to Unemp. to Zone 3 to Zone 5 to Unemp. to Zone 5", "Unemployment", 18.5, "UNE", "black")) %>%
rbind(c("Zone 5 to Unemp. to Zone 3 to Zone 5 to Unemp. to Zone 5", "Unemployment", 20, "Z5", "black"))

colnames(labs) <- c("cluster", "cluster_group", "Year", "label", "label_color")
labs$Year <- as.numeric(labs$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:20), breaks = c(seq(1, 20, by = 2))) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,1,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 20.5, fill = NA), hjust = 0, size = 6) + 
  geom_text(data = labs, aes(label = label, y = cluster, x = Year, color = label_color, fill = NA), size = 6) + scale_color_manual(values = c("white" = "white", "black" = "black"), guide = FALSE) +
  expand_limits(x = 23) +
  guides(fill = guide_legend(title.position = "top")) + 
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank(),
         axis.ticks.y = element_blank())

## 30 years ----------------------------

cluster_20 <- seq.30cluster_10$cluster$clustering
cluster_20_fac <- factor(cluster_20)

seqrep_plot <- function(cluster_number = "7088", cluster = "Education to Zone 5", cluster_group = "Education") {
output <- seqrep(seq.30[cluster_20_fac== cluster_number ,], group = cluster_20_fac, diss = seq.30cluster_10$diss[cluster_20_fac==cluster_number,cluster_20_fac== cluster_number])
output <- output[1,]
output <- output %>% gather() %>% rename("Year" = "key", "State" = "value") %>% mutate("cluster" = cluster, "cluster_group" = cluster_group, "nseq" = nrow(seq.30[cluster_20_fac == cluster_number,])) }

one <- seqrep_plot(cluster_number = "3", cluster = "Zone 4 to Ed. to Uenmp. to Ed. to Zone 4 to Uenmp. to Zone 4", cluster_group = "Education")
two <- seqrep_plot(cluster_number = "40", cluster = "Zone 4 to Education to Zone 4", cluster_group = "Education")
three <- seqrep_plot(cluster_number = "122", cluster = "Zone 4 to Zone 5 2", cluster_group = "Education")
four <- seqrep_plot(cluster_number = "135", cluster = "Zone 4 to Zone 2", cluster_group = "Education")
five <- seqrep_plot(cluster_number = "186", cluster = "Zone 5 to Education to Zone 5", cluster_group = "Education")

six <- seqrep_plot(cluster_number = "238", cluster = "Education to Zone 3 to Zone 4", cluster_group = "Education")
seven <- seqrep_plot(cluster_number = "302", cluster = "Zone 4 to Zone 3", cluster_group = "Demotion")
eight <- seqrep_plot(cluster_number = "303", cluster = "Zone 4 to Zone 5", cluster_group = "Promotion")
nine <- seqrep_plot(cluster_number = "314", cluster = "Zone 4", cluster_group = "No Change")
ten <- seqrep_plot(cluster_number = "325", cluster = "Zone 2 to Zone 3", cluster_group = "Education")

test <- rbind(one, two, three, four, five, six, seven, eight, nine, ten)
test$Year <- as.numeric(test$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:30), breaks = c(seq(1, 30, by = 5))) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,1,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 30.5, fill = NA), hjust = 0, size = 6) +
  expand_limits(x = 36) +
  guides(fill = guide_legend(title.position = "top"))

labs <- data.frame("Zone 5 to Education to Zone 5", "Education", 1.5, "Z5", "black") %>% 
rbind(c("Zone 5 to Education to Zone 5", "Education", 4, "EDU", "black")) %>%
rbind(c("Zone 5 to Education to Zone 5", "Education", 17, "Z5", "black")) %>%
  
rbind(c("Zone 4 to Education to Zone 4", "Education", 4, "Z4", "black")) %>%
rbind(c("Zone 4 to Education to Zone 4", "Education", 8, "EDU", "black")) %>%
rbind(c("Zone 4 to Education to Zone 4", "Education", 20, "Z4", "black")) %>%  
 
rbind(c("Education to Zone 3 to Zone 4", "Education", 3.5, "EDU", "black")) %>%
rbind(c("Education to Zone 3 to Zone 4", "Education", 13.5, "Z3", "white")) %>%
rbind(c("Education to Zone 3 to Zone 4", "Education", 25, "Z4", "black")) %>%
  
rbind(c("Zone 4 to Zone 5 2", "Education", 2, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 5 2", "Education", 11, "UNE", "black")) %>%
rbind(c("Zone 4 to Zone 5 2", "Education", 22, "EDU", "black")) %>%
rbind(c("Zone 4 to Zone 5 2", "Education", 26, "UNE", "black")) %>%
rbind(c("Zone 4 to Zone 5 2", "Education", 29, "Z5", "black")) %>%
  
rbind(c("Zone 2 to Zone 3", "Education", 1, "Z4", "black")) %>%
rbind(c("Zone 2 to Zone 3", "Education", 2.5, "EDU", "black")) %>%
rbind(c("Zone 2 to Zone 3", "Education", 4.5, "Z4", "black")) %>%
rbind(c("Zone 2 to Zone 3", "Education", 7, "Z2", "white")) %>%
rbind(c("Zone 2 to Zone 3", "Education", 11, "UNE", "black")) %>%
rbind(c("Zone 2 to Zone 3", "Education", 15, "Z2", "white")) %>%
rbind(c("Zone 2 to Zone 3", "Education", 18, "UNE", "white")) %>%
rbind(c("Zone 2 to Zone 3", "Education", 21, "Z2", "white")) %>%
rbind(c("Zone 2 to Zone 3", "Education", 27, "Z3", "white")) %>%
    
rbind(c("Zone 4 to Ed. to Uenmp. to Ed. to Zone 4 to Uenmp. to Zone 4", "Education", 3.5, "Z4", "black")) %>%
rbind(c("Zone 4 to Ed. to Uenmp. to Ed. to Zone 4 to Uenmp. to Zone 4", "Education", 9, "EDU", "black")) %>%
rbind(c("Zone 4 to Ed. to Uenmp. to Ed. to Zone 4 to Uenmp. to Zone 4", "Education", 12.5, "UNE", "black")) %>%
rbind(c("Zone 4 to Ed. to Uenmp. to Ed. to Zone 4 to Uenmp. to Zone 4", "Education", 16, "EDU", "black")) %>%
rbind(c("Zone 4 to Ed. to Uenmp. to Ed. to Zone 4 to Uenmp. to Zone 4", "Education", 20, "Z4", "black")) %>%
rbind(c("Zone 4 to Ed. to Uenmp. to Ed. to Zone 4 to Uenmp. to Zone 4", "Education", 24, "UNE", "black")) %>%
rbind(c("Zone 4 to Ed. to Uenmp. to Ed. to Zone 4 to Uenmp. to Zone 4", "Education", 28, "Z4", "black")) %>%
  
rbind(c("Zone 4 to Zone 2", "Education", 7, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 2", "Education", 14.5, "Z5", "black")) %>%
rbind(c("Zone 4 to Zone 2", "Education", 17, "EDU", "black")) %>%
rbind(c("Zone 4 to Zone 2", "Education", 20, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 2", "Education", 23.5, "Z5", "black")) %>%
rbind(c("Zone 4 to Zone 2", "Education", 26, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 2", "Education", 29, "Z2", "white")) %>%
  
rbind(c("Zone 4 to Zone 5", "Promotion", 7, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 5", "Promotion", 14.5, "UNE", "black")) %>%
rbind(c("Zone 4 to Zone 5", "Promotion", 23, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 5", "Promotion", 29, "Z5", "black")) %>%
  
rbind(c("Zone 4", "No Change", 16, "Z4", "black")) %>%
  
rbind(c("Zone 4 to Zone 3", "Demotion", 4, "Z4", "black")) %>%
rbind(c("Zone 4 to Zone 3", "Demotion", 13, "UNE", "black")) %>%
rbind(c("Zone 4 to Zone 3", "Demotion", 25, "Z3", "white"))


colnames(labs) <- c("cluster", "cluster_group", "Year", "label", "label_color")
labs$Year <- as.numeric(labs$Year)

labels <- test %>% select(cluster, cluster_group, nseq) %>% distinct()
test %>% ggplot(aes(x = Year, y = reorder(cluster, nseq), fill = State)) +
  geom_tile(aes(height = 0.9)) +
  facet_wrap(~ factor(cluster_group, levels = c("Education", "Promotion", "No Change", "Demotion", "Unemployment")), ncol = 1, scales = "free") +
  scale_fill_manual(values = c("1" = uva_color_palette[1], 
                               "2" = uva_color_palette[2],
                               "3" = uva_color_palette[4],  
                               "4" = uva_color_palette[6],
                               "5" = uva_color_palette[9], 
                               "6" = uva_color_palette[5], 
                               "Civilian unemployment" = "#CBBEB5"), 
                    labels = c("1" = "Zone 1", "2" = "Zone 2", "3" = "Zone 3",
                              "4" = "Zone 4", "5" = "Zone 5",
                               "6" = "Education", "Civilian unemployment" =
                                "Unemployed")) +
  scale_x_discrete(limits=c(1:30), breaks = c(seq(1, 30, by = 5))) +
  labs(x = "Year of Career", y = "") +
  theme(axis.ticks.y = element_blank(), text = element_text(size = 25),
        legend.position = "bottom", plot.margin = unit(c(1,1,1,1), "lines"))+
  geom_text(data = labels, aes(label = paste0("N = ", nseq), y = cluster, x = 30.5, fill = NA), hjust = 0, size = 6) + 
  geom_text(data = labs, aes(label = label, y = cluster, x = Year, color = label_color, fill = NA), size = 6) + scale_color_manual(values = c("white" = "white", "black" = "black"), guide = FALSE) +
  expand_limits(x = 33) +
  guides(fill = guide_legend(title.position = "top")) + 
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank(),
         axis.ticks.y = element_blank())
```


```{r veteran-clusters-ten-years, fig.height=15, fig.width=20}
# Visualizing 10 years 20 cluster solution ----------------------
seq.10cluster_20$cluster$stats

cluster_20 <- seq.10cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(933, 1500, 1336, 1511) ~ "education",
cluster %in% c(2607, 4345, 4416, 4690) ~ "promotion",
cluster %in% c(2769, 4409) ~ "demotion",
cluster %in% c(2727, 4303, 4390, 4684) ~ "unemployment",
cluster %in% c(2763, 2772, 4169, 4427, 4705, 4830) ~ "no change"
),
cluster_label = case_when(
  cluster == 933 ~ "Zone 5 to Education to Zone 5",
  cluster == 1500 ~ "Zone 4 to Education to Zone 4",
  cluster == 1336 ~ "Education to Zone 4",
  cluster == 1511 ~ "Zone 4 to Education",
  cluster == 2607 ~ "Zone 4 to Zone 5",
  cluster == 2727 ~ "Zone 4 to Unemployment to Zone 5",
  cluster == 2763 ~ "Zone 5",
  cluster == 2769 ~ "Zone 5 to Zone 4",
  cluster == 2772 ~ "Zone 4 to Zone 5 Zone 4",
  cluster == 4169 ~ "Zone 4 to Zone 3 to Zone 4",
  cluster == 4303 ~ "Zone 4 to Unemployment to Zone 4",
  cluster == 4345 ~ "Zone 3 to Zone 4",
  cluster == 4390 ~ "Zone 4 to Unemployment",
  cluster == 4409 ~ "Zone 4 to Zone 3",
  cluster == 4416 ~ "Zone 2 to Zone 4",
  cluster == 4427 ~ "Zone 4",
  cluster == 4684 ~ "Zone 3 to Unemployment",
  cluster == 4690 ~ "Zone 2 to Zone 3",
  cluster == 4705 ~ "Zone 3",
  cluster == 4830 ~ "Zone 2"
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")

all_df$irr_bin <- as.factor(as.character(all_df$irr_bin)) %>%  fct_collapse(all_df$irr_bin, 
               "Most Urban" = "1",
               "Other" = c("2", "3", "4"),
               "Most Rural" = "5")

seqdplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

seqrplot(seq.10, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start", diss = seq.10cluster_20$diss, main = "blah",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

#data_profiling(all_df)

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

all_df <- all_df %>% mutate(end_onet55_label = case_when(
  end_onet55 == "55-3011.00" ~ "Air Crew Members",
  end_onet55 == "55-1011.00" ~ "Air Crew Officers",
  end_onet55 == "55-1012.00" ~ "Aircraft Launch and Recovery Officers",
  end_onet55 == "55-3012.00" ~ "Aircraft Launch and Recovery Specialists",
  end_onet55 == "55-3013.00" ~ "Armored Assault Vehicle Crew Members",
  end_onet55 == "55-1013.00" ~ "Armored Assault Vehicle Officers",
  end_onet55 == "55-3014.00" ~ "Artillery and Missile Crew Members",
  end_onet55 == "55-1014.00" ~ "Artillery and Missile Officers",
  end_onet55 == "55-1015.00" ~ "Command and Control Center Officers",
  end_onet55 == "55-3015.00" ~ "Command and Control Center Specialists",
  end_onet55 == "55-2011.00" ~ "First-Line Supervisors of Air Crew Members",
  end_onet55 == "55-2013.00" ~ "First-Line Supervisors of All Other Tactical \n Operations Specialists",
  end_onet55 == "55-2012.00" ~ "First-Line Supervisors of Weapons \n Specialists/Crew Members",
  end_onet55 == "55-3016.00" ~ "Infantry",
  end_onet55 == "55-1016.00" ~ "Infantry Officers",
  end_onet55 == "55-3019.00" ~ "Military Enlisted Tactical Operations and \n Air/Weapons Specialists and Crew Members, All Other",
  end_onet55 == "55-1019.00" ~ "Military Officer Special and Tactical Operations \n Leaders, All Other",
  end_onet55 == "55-3018.00" ~ "Special Forces",
  end_onet55 == "55-1017.00" ~ "Special Forces Officers",
), years_in_military_bin = factor(years_in_military_bin, levels = c("1 - 2", "3 - 4", "5 - 10", "11 - 20", "21 - 30", "31+")), 
          year_military_enlist_bin = factor(year_military_enlist_bin, levels = c("Vietnam era (1964 to 1974)", "1975 to 1989", "1990 to 2000 (including Persian Gulf War)", "2001 or later")),
          career_before_military_bin = factor(career_before_military_bin, levels = c("0", "1 - 4", "5 - 10", "11 - 20", "21 - 30", "31+")),
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))

plot <- cluster_membership_visualization(veteran) 
plot + scale_fill_discrete(labels = c("not veteran" = "Non-Veteran", "veteran" = "Veteran"), name = "Veteran Status")
plot <- cluster_membership_visualization(highest_degree)
plot + scale_fill_discrete(labels = c("High School", "GED/Diploma", "Associates", "Bachelors", "Masters", "PhD"), name = "Highest Degree Earned")
plot <- cluster_membership_visualization(gender)
plot + scale_fill_discrete(labels = c("Male", "Female"), name = "Gender")
plot <- cluster_membership_visualization(irr_bin)
plot + scale_fill_discrete(name = "Relative Rurality")
#plot <- cluster_membership_visualization(highest_degree_from_forprofit)
#plot + scale_fill_discrete(labels = c(), name = "Gender")
#plot <- cluster_membership_visualization(highest_degree_from_hbcu)
#plot + scale_fill_discrete(labels = c(), name = "Gender")
plot <- cluster_membership_visualization(year_entered_workforce_bin)
plot + scale_fill_discrete(labels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial", "Post-Millennial"), name = "Generation cohort \n (by year entered the workforce)") +
  guides(fill = guide_legend(nrow = 2, title.position = "top"))
plot <- cluster_membership_visualization_skillmajor(top_skill)
plot + labs(y = "Top Skill") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion"))
plot <- cluster_membership_visualization_skillmajor(skill)
plot + labs(y = "All Skills") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion"))
plot <- cluster_membership_visualization_skillmajor(top_major)
plot + labs(y = "Top Major (Shorthand)") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("health_professions" = "Health Professions", "social_sciences" = "Social Sciences", "business" = "Business", "computer" = "Computer Science", "public_administration" = "Public Administration", "visual_arts" = "Visual Arts", "engineering_tech" = "Engineering Technologies/Technicians", "biology" = "Biology", "humanities" = "Liberal Arts and Humanities", "communication" = "Communication", "engineering" = "Engineering", "philosophy_religion" = "Philosophy and Religious Studies", "psychology" = "Psychology", "homeland_security" = "Homeland Security", "physics" = "Physics", "family_consumer" = "Family and Consumer Sciences", "theology_religion" = "Theology and Religious Vocations", "culinary_entertainment" = "Culinary and Entertainment Services", "language_linguistics" = "Foreign Languages and Lingustics", "mathematics" = "Mathematics", "education" = "Education", "recreation_kinesiology" = "Parks, Recreation, and Kinesiology", "english" = "English", "cultural_gender" = "Cultural/Gender Studies", "law" = "Legal Studies", "agriculture_veterinary" = "Agricultual/Vetrinary Studies", "leisure_recreation" = "Lesiure and Recreational Activities", "construction" = "Construction", "library" = "Library Science", "natural_resource" = "Natural Resources and Conservation", "architecture" = "Architecture", "interdisciplinary" = "Interdisciplinary Studies", "communication_tech" = "Communication Technologies/Technicians", "transportation_materials" = "Transportation and Materials Moving", "health_residency" = "Health Residency/Fellowship Programs", "military_science" = "Military Science", "mechanic_repair" = "Mechanic and Repair Technologies/Technicians", "science_tech" = "Science Technologies/Technicians", "military_tech" = "Military Technologies"))
plot <- cluster_membership_visualization_skillmajor(major)
plot + labs(y = "All Majors (Shorthand)") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("health_professions" = "Health Professions", "social_sciences" = "Social Sciences", "business" = "Business", "computer" = "Computer Science", "public_administration" = "Public Administration", "visual_arts" = "Visual Arts", "engineering_tech" = "Engineering Technologies/Technicians", "biology" = "Biology", "humanities" = "Liberal Arts and Humanities", "communication" = "Communication", "engineering" = "Engineering", "philosophy_religion" = "Philosophy and Religious Studies", "psychology" = "Psychology", "homeland_security" = "Homeland Security", "physics" = "Physics", "family_consumer" = "Family and Consumer Sciences", "theology_religion" = "Theology and Religious Vocations", "culinary_entertainment" = "Culinary and Entertainment Services", "language_linguistics" = "Foreign Languages and Lingustics", "mathematics" = "Mathematics", "education" = "Education", "recreation_kinesiology" = "Parks, Recreation, and Kinesiology", "english" = "English", "cultural_gender" = "Cultural/Gender Studies", "law" = "Legal Studies", "agriculture_veterinary" = "Agricultual/Vetrinary Studies", "leisure_recreation" = "Lesiure and Recreational Activities", "construction" = "Construction", "library" = "Library Science", "natural_resource" = "Natural Resources and Conservation", "architecture" = "Architecture", "interdisciplinary" = "Interdisciplinary Studies", "communication_tech" = "Communication Technologies/Technicians", "transportation_materials" = "Transportation and Materials Moving", "health_residency" = "Health Residency/Fellowship Programs", "military_science" = "Military Science", "mechanic_repair" = "Mechanic and Repair Technologies/Technicians", "science_tech" = "Science Technologies/Technicians", "military_tech" = "Military Technologies"))
cluster_membership_visualization_skillmajor(end_onet55_label)

plot <- cluster_membership_visualization(officer)
plot + scale_fill_discrete(labels = c("Not Officer", "Officer"), name = "Officer Status")
#plot <- cluster_membership_visualization_skillmajor(end_onet55_label)
plot <- cluster_membership_visualization(years_in_military_bin)
plot + scale_fill_discrete(labels = c("1 - 2", "3 - 4", "5 - 10", "11 - 20", "21 - 30", "31+"), name = "Years in Military")
plot <- cluster_membership_visualization(year_military_enlist_bin)
plot + scale_fill_discrete(labels = c("1940 or earlier", " World War II \n (1941 to 1946)", "1947 to 1949", "Korean war \n (1950 to 1954)", "1955 to 1963", "Vietnam era \n (1964 to 1974)", "1975 to 1989", "1990 to 2000 \n (including Persian \n Gulf War)", "2001 or later"), name = "Year of Military Enlist")
plot <- cluster_membership_visualization(career_before_military_bin)
plot + scale_fill_discrete(labels = c("0", "1 - 4", "5 - 10", "11 - 20", "21 - 30", "31+"), name = "Years of Career Before Military")

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)

plot +
  theme(text = element_text(size = 20), axis.text.x = element_text(size = 17),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 17)) +
  xlab("Cluster Label") +
  ylab("Top Skill") +
  scale_y_discrete(labels = c("information" = "Information Technology", "supply" = "Supply Chain \n and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and \n Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and \n Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care \n and Services", "legal" = "Legal", "education" = "Education and \n Training", "health" = "Health Care", "science" = "Science and \n Research", "human" = "Human Resources", "marketing" = "Marketing and \n Public Relations", "energy" = "Energy and \n Utilities", "economics" = "Economics, Policy, \n and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, \n and Installation", "agriculture" = "Agriculture, Horticulture, \n and the Outdoors", "architecture" = "Architecture and \n Construction", "industry" = "Industry Knowledge", "security" = "Public Safety \n and National Security", "religion" = "Religion")) +
  geom_tile(aes(height = 1))
```

```{r veteran-clusters-twenty-years, fig.height=15, fig.width=20}
# Visualizing 20 years 20 cluster solution --------------------------------------------------
seq.20cluster_20$cluster$stats

cluster_20 <- seq.20cluster_20$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(91, 163, 343, 452) ~ "education",
cluster %in% c(628, 1020, 1071, 1348, 1643) ~ "promotion",
cluster %in% c(576, 1363, 1428, 1690, 1720) ~ "demotion",
cluster %in% c(668, 1078, 1566) ~ "unemployment",
cluster %in% c(1018, 1027, 1627) ~ "no change"
),
cluster_label = case_when(
  cluster == 91 ~ "Education to Unemployment",
  cluster == 163 ~ "Zone 4 to Education to Zone 4",
  cluster == 343 ~ "Education to Zone 5",
  cluster == 452 ~ "Education to Zone 4",
  cluster == 576 ~ "Zone 5 to Zone 4",
  cluster == 628 ~ "Zone 4 to Zone 5 (Early Career)",
  cluster == 668 ~ "Zone 4/5 to Unemployment to Cone 5",
  cluster == 1018 ~ "Zone 4 to Zone 5 to Zone 4",
  cluster == 1020 ~ "Zone 4 to Zone 5 (Late Career)",
  cluster == 1027 ~ "Zone 5",
  cluster == 1071 ~ "Zone 3 to Zone 4 (Early Career)",
  cluster == 1078 ~ "Zone 4 to Unemployment",
  cluster == 1348 ~ "Zone 3 to Zone 4 (Mid Career)",
  cluster == 1363 ~ "Zone 4 to Zone 3 (Mid Career)",
  cluster == 1428 ~ "Zone 4 to Zone 2 (Mid Career)",
  cluster == 1566 ~ "Zone 4 to Unemployment to Zone 4",
  cluster == 1627 ~ "Zone 4",
  cluster == 1643 ~ "Zone 2 to Zone 3",
  cluster == 1690 ~ "Zone 4 to Zone 3 (Early Career)",
  cluster == 1720 ~ "Zone 4 to Zone 2 (Early Career)"
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")

# Plotting
seqdplot(seq.20, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

seqrplot(seq.20, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, with.legend = F, sortv = "from.start", diss = seq.20cluster_20$diss,
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

all_df <- all_df %>% mutate(end_onet55_label = case_when(
  end_onet55 == "55-3011.00" ~ "Air Crew Members",
  end_onet55 == "55-1011.00" ~ "Air Crew Officers",
  end_onet55 == "55-1012.00" ~ "Aircraft Launch and Recovery Officers",
  end_onet55 == "55-3012.00" ~ "Aircraft Launch and Recovery Specialists",
  end_onet55 == "55-3013.00" ~ "Armored Assault Vehicle Crew Members",
  end_onet55 == "55-1013.00" ~ "Armored Assault Vehicle Officers",
  end_onet55 == "55-3014.00" ~ "Artillery and Missile Crew Members",
  end_onet55 == "55-1014.00" ~ "Artillery and Missile Officers",
  end_onet55 == "55-1015.00" ~ "Command and Control Center Officers",
  end_onet55 == "55-3015.00" ~ "Command and Control Center Specialists",
  end_onet55 == "55-2011.00" ~ "First-Line Supervisors of Air Crew Members",
  end_onet55 == "55-2013.00" ~ "First-Line Supervisors of All Other Tactical Operations Specialists",
  end_onet55 == "55-2012.00" ~ "First-Line Supervisors of Weapons Specialists/Crew Members",
  end_onet55 == "55-3016.00" ~ "Infantry",
  end_onet55 == "55-1016.00" ~ "Infantry Officers",
  end_onet55 == "55-3019.00" ~ "Military Enlisted Tactical Operations and \n Air/Weapons Specialists and Crew Members, All Other",
  end_onet55 == "55-1019.00" ~ "Military Officer Special and Tactical \n Operations Leaders, All Other",
  end_onet55 == "55-3018.00" ~ "Special Forces",
  end_onet55 == "55-1017.00" ~ "Special Forces Officers",
), years_in_military_bin = factor(years_in_military_bin, levels = c("1 - 2", "3 - 4", "5 - 10", "11 - 20", "21 - 30", "31+")), 
          year_military_enlist_bin = factor(year_military_enlist_bin, levels = c("Vietnam era (1964 to 1974)", "1975 to 1989", "1990 to 2000 (including Persian Gulf War)", "2001 or later")),
          career_before_military_bin = factor(career_before_military_bin, levels = c("0", "1 - 4", "5 - 10", "11 - 20", "21 - 30", "31+")),
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))

plot <- cluster_membership_visualization(veteran) 
plot + scale_fill_discrete(labels = c("not veteran" = "Non-Veteran", "veteran" = "Veteran"), name = "Veteran Status")
plot <- cluster_membership_visualization(highest_degree)
plot + scale_fill_discrete(labels = c("High School", "GED/Diploma", "Associates", "Bachelors", "Masters", "PhD"), name = "Highest Degree Earned")
plot <- cluster_membership_visualization(gender)
plot + scale_fill_discrete(labels = c("Male", "Female"), name = "Gender")
plot <- cluster_membership_visualization(irr_bin)
plot + scale_fill_discrete(name = "Relative Rurality")
#plot <- cluster_membership_visualization(highest_degree_from_forprofit)
#plot + scale_fill_discrete(labels = c(), name = "Gender")
#plot <- cluster_membership_visualization(highest_degree_from_hbcu)
#plot + scale_fill_discrete(labels = c(), name = "Gender")
plot <- cluster_membership_visualization(year_entered_workforce_bin)
plot + scale_fill_discrete(labels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial", "Post-Millennial"), name = "Generation cohort \n (by year entered the workforce)") +
  guides(fill = guide_legend(nrow = 2, title.position = "top"))
plot <- cluster_membership_visualization_skillmajor(top_skill)
plot + labs(y = "Top Skill") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion"))
plot <- cluster_membership_visualization_skillmajor(skill)
plot + labs(y = "All Skills") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("information" = "Information Technology", "supply" = "Supply Chain and Logistics", "sales" = "Sales", "business" = "Business", "manufacturing" = "Manufacturing and Production", "environment" = "Environment", "design" = "Design", "administration" = "Administration", "customer" = "Customer and Client Support", "analysis" = "Analysis", "finance" = "Finance", "personal" = "Personal Care and Services", "legal" = "Legal", "education" = "Education and Training", "health" = "Health Care", "science" = "Science and Research", "human" = "Human Resources", "marketing" = "Marketing and Public Relations", "energy" = "Energy and Utilities", "economics" = "Economics, Policy, and Social Studies", "media" = "Media and Writing", "engineering" = "Engineering", "maintenance" = "Maintenance, Repair, and Installation", "agriculture" = "Agriculture, Horticulture, and the Outdoors", "architecture" = "Architecture and Construction", "industry" = "Industry Knowledge", "security" = "Public Safety and National Security", "religion" = "Religion"))
plot <- cluster_membership_visualization_skillmajor(top_major)
plot + labs(y = "Top Major (Shorthand)") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("health_professions" = "Health Professions", "social_sciences" = "Social Sciences", "business" = "Business", "computer" = "Computer Science", "public_administration" = "Public Administration", "visual_arts" = "Visual Arts", "engineering_tech" = "Engineering Technologies/Technicians", "biology" = "Biology", "humanities" = "Liberal Arts and Humanities", "communication" = "Communication", "engineering" = "Engineering", "philosophy_religion" = "Philosophy and Religious Studies", "psychology" = "Psychology", "homeland_security" = "Homeland Security", "physics" = "Physics", "family_consumer" = "Family and Consumer Sciences", "theology_religion" = "Theology and Religious Vocations", "culinary_entertainment" = "Culinary and Entertainment Services", "language_linguistics" = "Foreign Languages and Lingustics", "mathematics" = "Mathematics", "education" = "Education", "recreation_kinesiology" = "Parks, Recreation, and Kinesiology", "english" = "English", "cultural_gender" = "Cultural/Gender Studies", "law" = "Legal Studies", "agriculture_veterinary" = "Agricultual/Vetrinary Studies", "leisure_recreation" = "Lesiure and Recreational Activities", "construction" = "Construction", "library" = "Library Science", "natural_resource" = "Natural Resources and Conservation", "architecture" = "Architecture", "interdisciplinary" = "Interdisciplinary Studies", "communication_tech" = "Communication Technologies/Technicians", "transportation_materials" = "Transportation and Materials Moving", "health_residency" = "Health Residency/Fellowship Programs", "military_science" = "Military Science", "mechanic_repair" = "Mechanic and Repair Technologies/Technicians", "science_tech" = "Science Technologies/Technicians", "military_tech" = "Military Technologies"))
plot <- cluster_membership_visualization_skillmajor(major)
plot + labs(y = "All Majors (Shorthand)") + theme(axis.text.x = element_text(angle = 60, hjust = 1)) + scale_y_discrete(labels = c("health_professions" = "Health Professions", "social_sciences" = "Social Sciences", "business" = "Business", "computer" = "Computer Science", "public_administration" = "Public Administration", "visual_arts" = "Visual Arts", "engineering_tech" = "Engineering Technologies/Technicians", "biology" = "Biology", "humanities" = "Liberal Arts and Humanities", "communication" = "Communication", "engineering" = "Engineering", "philosophy_religion" = "Philosophy and Religious Studies", "psychology" = "Psychology", "homeland_security" = "Homeland Security", "physics" = "Physics", "family_consumer" = "Family and Consumer Sciences", "theology_religion" = "Theology and Religious Vocations", "culinary_entertainment" = "Culinary and Entertainment Services", "language_linguistics" = "Foreign Languages and Lingustics", "mathematics" = "Mathematics", "education" = "Education", "recreation_kinesiology" = "Parks, Recreation, and Kinesiology", "english" = "English", "cultural_gender" = "Cultural/Gender Studies", "law" = "Legal Studies", "agriculture_veterinary" = "Agricultual/Vetrinary Studies", "leisure_recreation" = "Lesiure and Recreational Activities", "construction" = "Construction", "library" = "Library Science", "natural_resource" = "Natural Resources and Conservation", "architecture" = "Architecture", "interdisciplinary" = "Interdisciplinary Studies", "communication_tech" = "Communication Technologies/Technicians", "transportation_materials" = "Transportation and Materials Moving", "health_residency" = "Health Residency/Fellowship Programs", "military_science" = "Military Science", "mechanic_repair" = "Mechanic and Repair Technologies/Technicians", "science_tech" = "Science Technologies/Technicians", "military_tech" = "Military Technologies"))
cluster_membership_visualization_skillmajor(end_onet55_label)

plot <- cluster_membership_visualization(officer)
plot + scale_fill_discrete(labels = c("Not Officer", "Officer"), name = "Officer Status")
#plot <- cluster_membership_visualization_skillmajor(end_onet55_label)
plot <- cluster_membership_visualization(years_in_military_bin)
plot + scale_fill_discrete(labels = c("1 - 2", "3 - 4", "5 - 10", "11 - 20", "21 - 30", "31+"), name = "Years in Military")
plot <- cluster_membership_visualization(year_military_enlist_bin)
plot + scale_fill_discrete(labels = c("1940 or earlier", " World War II \n (1941 to 1946)", "1947 to 1949", "Korean war \n (1950 to 1954)", "1955 to 1963", "Vietnam era \n (1964 to 1974)", "1975 to 1989", "1990 to 2000 \n (including Persian \n Gulf War)", "2001 or later"), name = "Year of Military Enlist")
plot <- cluster_membership_visualization(career_before_military_bin)
plot + scale_fill_discrete(labels = c("0", "1 - 4", "5 - 10", "11 - 20", "21 - 30", "31+"), name = "Years of Career Before Military")

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)
```

```{r veteran-clusters-thirty-years, fig.height=10, fig.width=15}
# Visualizing 30 years 10 cluster solution -------------------------------------------------
seq.30cluster_10$cluster$stats

cluster_20 <- seq.30cluster_10$cluster$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.30)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id") %>% mutate(cluster_group = case_when(
  cluster %in% c(3, 40, 122) ~ "education",
cluster %in% c(135, 325) ~ "promotion",
#cluster %in% c() ~ "demotion",
cluster %in% c(302, 303) ~ "unemployment",
cluster %in% c(186, 238, 314) ~ "no change",
),
cluster_label = case_when(
  cluster == 3 ~ "zone 4 to education to zone 4 and unemmployment",
  cluster == 40 ~ "zone 4 to education to zone 4",
  cluster == 122 ~ "zone 4 to long unemployment to education to zone 5",
  cluster == 135 ~ "zone 4 to zone 5 to zone 4",
  cluster == 186 ~ "zone 5",
  cluster == 238 ~ "zone 3",
  cluster == 302 ~ "zone 4 to zone 3 to unemployment",
  cluster == 303 ~ "zone 4 to unemployment to zone 4",
  cluster == 314 ~ "zone 4",
  cluster == 325 ~ "zone 2 to zone 5 to zone 4"
), cluster_long = paste0(cluster_group, " - ", cluster_label))
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))
dataset_top_skills$id <- as.character(dataset_top_skills$id)
all_df <- all_df %>% left_join(dataset_top_skills, by = "id")
dataset_top_majors$id <- as.character(dataset_top_majors$id)
all_df <- all_df %>% left_join(dataset_top_majors, by = "id")
dataset_all_skills$id <- as.character(dataset_all_skills$id)
all_df <- all_df %>% left_join(dataset_all_skills, by = "id")
dataset_all_majors$id <- as.character(dataset_all_majors$id)
all_df <- all_df %>% left_join(dataset_all_majors, by = "id")

# Plotting
seqdplot(seq.30, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))

seqrplot(seq.30, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, with.legend = F, sortv = "from.start", diss = seq.30cluster_10$diss,
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5"))

all_df <- all_df %>% mutate(end_onet55_label = case_when(
  end_onet55 == "55-3011.00" ~ "Air Crew Members",
  end_onet55 == "55-1011.00" ~ "Air Crew Officers",
  end_onet55 == "55-1012.00" ~ "Aircraft Launch and Recovery Officers",
  end_onet55 == "55-3012.00" ~ "Aircraft Launch and Recovery Specialists",
  end_onet55 == "55-3013.00" ~ "Armored Assault Vehicle Crew Members",
  end_onet55 == "55-1013.00" ~ "Armored Assault Vehicle Officers",
  end_onet55 == "55-3014.00" ~ "Artillery and Missile Crew Members",
  end_onet55 == "55-1014.00" ~ "Artillery and Missile Officers",
  end_onet55 == "55-1015.00" ~ "Command and Control Center Officers",
  end_onet55 == "55-3015.00" ~ "Command and Control Center Specialists",
  end_onet55 == "55-2011.00" ~ "First-Line Supervisors of Air Crew Members",
  end_onet55 == "55-2013.00" ~ "First-Line Supervisors of All Other Tactical Operations Specialists",
  end_onet55 == "55-2012.00" ~ "First-Line Supervisors of Weapons Specialists/Crew Members",
  end_onet55 == "55-3016.00" ~ "Infantry",
  end_onet55 == "55-1016.00" ~ "Infantry Officers",
  end_onet55 == "55-3019.00" ~ "Military Enlisted Tactical Operations and Air/Weapons Specialists and Crew Members, All Other",
  end_onet55 == "55-1019.00" ~ "Military Officer Special and Tactical Operations Leaders, All Other",
  end_onet55 == "55-3018.00" ~ "Special Forces",
  end_onet55 == "55-1017.00" ~ "Special Forces Officers",
), years_in_military_bin = factor(years_in_military_bin, levels = c("1 - 2", "3 - 4", "5 - 10", "11 - 20", "21 - 30", "31+")), 
          year_military_enlist_bin = factor(year_military_enlist_bin, levels = c("Vietnam era (1964 to 1974)", "1975 to 1989", "1990 to 2000 (including Persian Gulf War)", "2001 or later")),
          career_before_military_bin = factor(career_before_military_bin, levels = c("0", "1 - 4", "5 - 10", "11 - 20", "21 - 30", "31+")),
          year_entered_workforce_bin = factor(year_entered_workforce_bin, levels = c("Silent and Greatest", "Baby Boom", "Generation X", "Millennial")),
highest_degree = factor(highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")), 
highest_degree_from_forprofit = factor(highest_degree_from_forprofit, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")),
highest_degree_from_hbcu = factor(highest_degree_from_hbcu, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd")))
cluster_membership_visualization(highest_degree)
cluster_membership_visualization(gender)
cluster_membership_visualization(irr_bin)
cluster_membership_visualization(highest_degree_from_forprofit)
cluster_membership_visualization(highest_degree_from_hbcu)
cluster_membership_visualization(year_entered_workforce_bin)

cluster_membership_visualization(officer)
cluster_membership_visualization(end_onet55_label)
cluster_membership_visualization(years_in_military_bin)
cluster_membership_visualization(year_military_enlist_bin)
cluster_membership_visualization(career_before_military_bin)

cluster_membership_visualization_skillmajor(end_onet55_label)
cluster_membership_visualization_skillmajor(top_skill)
cluster_membership_visualization_skillmajor(top_major)
cluster_membership_visualization_skillmajor(skill)
cluster_membership_visualization_skillmajor(major)

  df <- all_df %>%
  filter(!is.na(top_skill)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_skill) %>%
  group_by(top_skill) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_skill))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_skill, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_skill, difference)

  df <- all_df %>%
  filter(!is.na(top_major)) %>% distinct(id, cluster, cluster_long, cluster_group, cluster_label, top_major) %>%
  group_by(top_major) %>% mutate(variable_total = n()) %>% ungroup() %>% mutate(variable_percent = variable_total/n() * 100) %>%
  group_by(cluster) %>%
  mutate(cluster_total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/cluster_total * 100, difference = (percent - variable_percent)/variable_percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, variable_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

df$cluster <- as.factor(df$cluster)
df <- df %>% filter(!is.na(top_major))
df <- as.data.frame(df)

df %>% group_by(cluster_long) %>% slice_max(difference, n = 5) %>% select(cluster_long, top_major, difference)
df %>% group_by(cluster_long) %>% slice_min(difference, n = 5) %>% select(cluster_long, top_major, difference)
```








```{r, eval = FALSE}

library(RColorBrewer)

  overall <- all_df %>% filter(!is.na(top_skill)) %>% mutate(total = n()) %>% group_by(cluster) %>% mutate(overall_cluster_count = n()) %>% group_by(top_skill) %>% mutate(overall_covariate_percent = round((n()/total * 100), 2)) %>% distinct(top_skill, overall_covariate_percent) %>% mutate(cluster_label = "overall", cluster_group = "overall", overall_cluster_percent = .1) %>% rename(cluster_covariate_percent = overall_covariate_percent)
nb.cols <- length(unique(all_df$top_skill))
mycolors <- colorRampPalette(brewer.pal(8, "Set2"))(nb.cols)
all_df %>% filter(!is.na(top_skill)) %>% mutate(total = n()) %>% group_by(cluster) %>% mutate(overall_cluster_count = n(), overall_cluster_percent = n()/total) %>% group_by(top_skill) %>% mutate(overall_covariate_percent = round((n()/total * 100), 2)) %>% group_by(cluster, top_skill) %>% mutate(cluster_covariate_percent = round((n()/overall_cluster_count * 100), 2)) %>% distinct(cluster, cluster_label, cluster_group, top_skill, cluster_covariate_percent, overall_cluster_percent) %>% group_by(top_skill) %>% left_join(select(overall, overall = cluster_covariate_percent), by = "top_skill") %>% rbind(overall) %>% mutate(alpha = ifelse(!is.na(overall), abs((overall - cluster_covariate_percent)/overall), max(abs((overall - cluster_covariate_percent)/overall)))) %>%
  ggplot(aes(cluster_covariate_percent, cluster_label, fill = factor(top_skill), alpha = factor(alpha))) +
  geom_col(aes(width = overall_cluster_percent*10)) +
  facet_wrap(~ factor(cluster_group, levels = c("overall", "education", "promotion", "no change", "demotion", "unemployment")), ncol = 1, scales="free") + scale_fill_manual(values = mycolors) +
  scale_alpha_discrete(guide = "none")

#cluster_membership_visualization(skill)
#cluster_membership_visualization(major)

top_skill <- all_df %>%
  filter(!is.na(top_skill)) %>%
  group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(top_skill) %>%
  mutate(total = n()) %>%
  group_by(cluster, top_skill) %>%
  mutate(percent = n()/total * 100, difference = (percent - cluster_percent)/percent) %>%
  distinct(top_skill, cluster_long, cluster_group, cluster_label, percent, cluster_percent, difference) %>%
  group_by(top_skill) %>% mutate(sum = sum(percent))

top_skill$cluster <- as.factor(top_skill$cluster)
top_skill <- top_skill %>% filter(!is.na(top_skill))
top_skill <- as.data.frame(top_skill)

ggplot(top_skill, aes(cluster_label, top_skill, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0, limits = c(-10, 10))+
  theme_classic()+
  labs(title = "Cluster membership by top_skill") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(~cluster_group, switch = "x", scales = "free_x", space = "free_x")

top_major <- all_df %>%
  filter(!is.na(top_major)) %>%
  group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(top_major) %>%
  mutate(total = n()) %>%
  group_by(cluster, top_major) %>%
  mutate(percent = n()/total * 100, difference = (percent - cluster_percent)/percent) %>%
  distinct(top_major, cluster_long, cluster_group, cluster_label, percent, cluster_percent, difference) %>%
  group_by(top_major) %>% mutate(sum = sum(percent))

top_major$cluster <- as.factor(top_major$cluster)
top_major <- top_major %>% filter(!is.na(top_major))
top_major <- as.data.frame(top_major)

ggplot(top_major, aes(cluster_label, top_major, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0, limits = c(-10, 10))+
 theme_classic()+
  labs(title = "Cluster membership by top_major") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(~cluster_group, switch = "x", scales = "free_x", space = "free_x")

#install.packages("ggpubr", dependencies = TRUE)
#ggballoonplot(aes(x = all_df$cluster, y = all_df%top_skill))

#install.packages("FactoMineR", dependencies = TRUE)
#install.packages("factoextra", dependencies = TRUE)
#library(FactoMineR)
library(ca)
test <- all_df %>% select(cluster_label, cluster_group, top_skill) %>% mutate(value = 1)
table <- dcast(test, cluster_label ~ top_skill, fun.aggregate = sum)
table <- table %>% remove_rownames %>% column_to_rownames(var = "cluster_label")
#as.table(table)
plot(ca(table))

test <- all_df %>% select(cluster_label, cluster_group, top_major) %>% mutate(value = 1)
table <- dcast(test, cluster_label ~ top_major, fun.aggregate = sum)
table <- table %>% remove_rownames %>% column_to_rownames(var = "cluster_label")
#as.table(table)
plot(ca(table))


all_df %>% select(cluster_label, cluster_group, top_skill) %>% mutate(count = 1, total = n()) %>% group_by(top_skill) %>% mutate(skill_total = sum(count)) %>% ungroup() %>% group_by(cluster_label) %>% mutate(cluster_total = sum(count)) %>% group_by(cluster_label, top_skill) %>% mutate(value = sum(count)/cluster_total) %>%
ggplot(aes(x = cluster_label, y = top_skill)) +
  geom_point(aes(size=value),shape=21, colour="black", fill="skyblue")+
  theme(panel.background=element_blank(), panel.border = element_rect(colour = "blue", fill=NA, size=1))+
  scale_size_area(max_size=20)+
  facet_grid(~cluster_group, switch = "x", scales = "free_x", space = "free_x") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

cluster_membership_visualization_skillmajor(skill)


all_df %>% filter(!is.na(highest_degree), highest_degree != "post-bacc") %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(highest_degree) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(highest_degree, cluster, percent, cluster_percent, difference) %>%
  group_by(highest_degree) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, highest_degree, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by highest degree")
all_df %>% group_by(cluster) %>% filter(!is.na(gender)) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(gender) %>%
  mutate(total = n()) %>%
  group_by(cluster, gender) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(gender, cluster, percent, cluster_percent, difference) %>%
  group_by(gender) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, gender, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by gender")
all_df %>% group_by(cluster) %>% filter(highest_degree_from_forprofit != "highschool") %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(highest_degree_from_forprofit) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree_from_forprofit) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(highest_degree_from_forprofit, cluster, percent, cluster_percent, difference) %>%
  group_by(highest_degree_from_forprofit) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, highest_degree_from_forprofit, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by highest degree from forprofit")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(highest_degree_from_hbcu) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree_from_hbcu) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(highest_degree_from_hbcu, cluster, percent, cluster_percent, difference) %>%
  group_by(highest_degree_from_hbcu) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, highest_degree_from_hbcu, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by highest degree from hbcu")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(irr_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, irr_bin) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(irr_bin, cluster, percent, cluster_percent, difference) %>%
  group_by(irr_bin) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, irr_bin, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by IRR")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(officer) %>%
  mutate(total = n()) %>%
  group_by(cluster, officer) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(officer, cluster, percent, cluster_percent, difference) %>%
  group_by(officer) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, officer, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by officer")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(end_onet55) %>%
  mutate(total = n()) %>% filter(total > 10) %>%
  group_by(cluster, end_onet55) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(end_onet55, cluster, percent, cluster_percent, difference) %>%
  group_by(end_onet55) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, end_onet55, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by ending onet 55")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(year_military_enlist_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, year_military_enlist_bin) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(cluster, year_military_enlist_bin, percent, cluster_percent, difference) %>%
  group_by(year_military_enlist_bin) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, year_military_enlist_bin, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by year military enlist")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(year_entered_workforce_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, year_entered_workforce_bin) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(cluster, year_entered_workforce_bin, percent, cluster_percent, difference) %>%
  group_by(year_entered_workforce_bin) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, year_entered_workforce_bin, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by year entered the workforce")

# Visualizing 10 years 20 cluster solution
seq.20cluster_20$stats

cluster_20 <- seq.20cluster_20$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.10)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id")

veteran <- all_df %>%
  filter(!is.na(veteran)) %>%
  group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(veteran) %>%
  mutate(total = n()) %>%
  group_by(cluster, veteran) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(veteran, cluster, percent, cluster_percent, difference) %>%
  group_by(veteran) %>% mutate(sum = sum(percent))

veteran$cluster <- as.factor(veteran$cluster)
veteran <- veteran %>% filter(!is.na(veteran))
veteran <- as.data.frame(veteran)

seqdplot(seq.20, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))
ggplot(veteran, aes(cluster, veteran, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Clustering membership by veteran")

# Visualizing 30 years 20 cluster solution
seq.30cluster_5$stats

cluster_5 <- seq.30cluster_5$clustering
cluster_5_fac <- factor(cluster_5)
all <- rownames(seq.30)
all_df <- as.data.frame(cbind(all, cluster_5))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id")

veteran <- all_df %>%
  filter(!is.na(veteran)) %>%
  group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(veteran) %>%
  mutate(total = n()) %>%
  group_by(cluster, veteran) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(veteran, cluster, percent, cluster_percent, difference) %>%
  group_by(veteran) %>% mutate(sum = sum(percent))

veteran$cluster <- as.factor(veteran$cluster)
veteran <- veteran %>% filter(!is.na(veteran))
veteran <- as.data.frame(veteran)

seqdplot(seq.30, group = cluster_5_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))
ggplot(veteran, aes(cluster, veteran, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Clustering membership by veteran")

```
```{r, eval = FALSE}

all_df %>% filter(!is.na(highest_degree), highest_degree != "post-bacc") %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(highest_degree) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(highest_degree, cluster, percent, cluster_percent, difference) %>%
  group_by(highest_degree) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, highest_degree, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by highest degree")
all_df %>% group_by(cluster) %>% filter(!is.na(gender)) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(gender) %>%
  mutate(total = n()) %>%
  group_by(cluster, gender) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(gender, cluster, percent, cluster_percent, difference) %>%
  group_by(gender) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, gender, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by gender")
all_df %>% group_by(cluster) %>% filter(highest_degree_from_forprofit != "highschool") %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(highest_degree_from_forprofit) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree_from_forprofit) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(highest_degree_from_forprofit, cluster, percent, cluster_percent, difference) %>%
  group_by(highest_degree_from_forprofit) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, highest_degree_from_forprofit, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by highest degree from forprofit")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(highest_degree_from_hbcu) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree_from_hbcu) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(highest_degree_from_hbcu, cluster, percent, cluster_percent, difference) %>%
  group_by(highest_degree_from_hbcu) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, highest_degree_from_hbcu, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by highest degree from hbcu")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(irr_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, irr_bin) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(irr_bin, cluster, percent, cluster_percent, difference) %>%
  group_by(irr_bin) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, irr_bin, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by IRR")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(officer) %>%
  mutate(total = n()) %>%
  group_by(cluster, officer) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(officer, cluster, percent, cluster_percent, difference) %>%
  group_by(officer) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, officer, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by officer")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(end_onet55) %>%
  mutate(total = n()) %>% filter(total > 10) %>%
  group_by(cluster, end_onet55) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(end_onet55, cluster, percent, cluster_percent, difference) %>%
  group_by(end_onet55) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, end_onet55, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by ending onet 55")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(year_military_enlist_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, year_military_enlist_bin) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(cluster, year_military_enlist_bin, percent, cluster_percent, difference) %>%
  group_by(year_military_enlist_bin) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, year_military_enlist_bin, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by year military enlist")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(year_entered_workforce_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, year_entered_workforce_bin) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(cluster, year_entered_workforce_bin, percent, cluster_percent, difference) %>%
  group_by(year_entered_workforce_bin) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, year_entered_workforce_bin, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by year entered the workforce")

# Visualizing 20 years 20 cluster solution
seq.20cluster_20$stats

cluster_20 <- seq.20cluster_20$clustering
cluster_20_fac <- factor(cluster_20)
all <- rownames(seq.20)
all_df <- as.data.frame(cbind(all, cluster_20))
colnames(all_df) <- c("id", "cluster")
covariates <- bg_covariates
covariates$id <- as.character(covariates$id)

all_df <- left_join(all_df, covariates, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_forprofit, by = "id")
all_df <- all_df %>% left_join(highest_degree_from_hbcu, by = "id")
all_df <- all_df %>% mutate(irr_bin = ntile(irr, 5))

# Plotting
seqdplot(seq.20, group = cluster_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))

all_df %>% filter(!is.na(highest_degree), highest_degree != "post-bacc") %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(highest_degree) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(highest_degree, cluster, percent, cluster_percent, difference) %>%
  group_by(highest_degree) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, highest_degree, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by highest degree")
all_df %>% group_by(cluster) %>% filter(!is.na(gender)) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(gender) %>%
  mutate(total = n()) %>%
  group_by(cluster, gender) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(gender, cluster, percent, cluster_percent, difference) %>%
  group_by(gender) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, gender, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by gender")
all_df %>% group_by(cluster) %>% filter(highest_degree_from_forprofit != "highschool") %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(highest_degree_from_forprofit) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree_from_forprofit) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(highest_degree_from_forprofit, cluster, percent, cluster_percent, difference) %>%
  group_by(highest_degree_from_forprofit) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, highest_degree_from_forprofit, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by highest degree from forprofit")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(highest_degree_from_hbcu) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree_from_hbcu) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(highest_degree_from_hbcu, cluster, percent, cluster_percent, difference) %>%
  group_by(highest_degree_from_hbcu) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, highest_degree_from_hbcu, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by highest degree from hbcu")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(irr_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, irr_bin) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(irr_bin, cluster, percent, cluster_percent, difference) %>%
  group_by(irr_bin) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, irr_bin, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by IRR")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(officer) %>%
  mutate(total = n()) %>%
  group_by(cluster, officer) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(officer, cluster, percent, cluster_percent, difference) %>%
  group_by(officer) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, officer, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by officer")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(end_onet55) %>%
  mutate(total = n()) %>% filter(total > 10) %>%
  group_by(cluster, end_onet55) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(end_onet55, cluster, percent, cluster_percent, difference) %>%
  group_by(end_onet55) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, end_onet55, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by ending onet 55")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(year_military_enlist_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, year_military_enlist_bin) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(cluster, year_military_enlist_bin, percent, cluster_percent, difference) %>%
  group_by(year_military_enlist_bin) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, year_military_enlist_bin, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by year military enlist")
all_df %>% group_by(cluster) %>% mutate(cluster_total = n()) %>% ungroup() %>% mutate(cluster_percent = cluster_total/n() * 100) %>%
  group_by(year_entered_workforce_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, year_entered_workforce_bin) %>%
  mutate(percent = n()/total * 100, difference = percent - cluster_percent) %>%
  distinct(cluster, year_entered_workforce_bin, percent, cluster_percent, difference) %>%
  group_by(year_entered_workforce_bin) %>% mutate(sum = sum(percent)) %>%
ggplot(aes(cluster, year_entered_workforce_bin, fill= difference)) + 
  geom_tile()+
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0)+
  theme_classic()+
  labs(title = "Cluster membership by year entered the workforce")
```



```{r clustering, fig.height=10, fig.width=15, eval = FALSE}
vet.seq <- create_seq_vet_fixed("vet.seq", 10, left_unemp = TRUE)

transition_matrix <- seqtrate(vet.seq, weighted=FALSE, count=TRUE)
round(transition_matrix,2)
diag(transition_matrix) = 0
round(transition_matrix,2)
rowsum <- apply(transition_matrix, 1, sum)
for(i in 1:nrow(transition_matrix)) {
  for (j in 1:ncol(transition_matrix)){
    transition_matrix[i,j] = transition_matrix[i,j]/rowsum[i]
  }
}
for(j in 1:ncol(transition_matrix)){
      transition_matrix[7,j] = transition_matrix[7,j] = 0
}
transition_matrix <- round(transition_matrix,2)
cost_matrix <- 2-transition_matrix
round(cost_matrix,2)
diag(cost_matrix) = 0
cost_matrix <- round(cost_matrix,2)

# OPTION 1 : OUR OM SPELL, LOW EXPANSION COST AND LOW WEIGHT
sequencing.opt1 <- seqdist(vet.seq, method = "OMspell", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0, expcost = 0)

# OPTION 2 : OUR OM
sequencing.opt2 <- seqdist(vet.seq, method = "OMstran", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0.5)

# OPTION 3 : OUR OM, LOW WEIGHT ON ORIGIN
sequencing.opt3 <- seqdist(vet.seq, method = "OMstran", indel = 1, sm = cost_matrix, with.missing = TRUE, otto = 0.01)

# CLUSTERING
numbers <- (2:20)
pamstats <- NULL
#rownames(pamstats) <- numbers
pamstats <- NULL
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt1, k = number)
  assign(paste0("sequencing.pam.opt1.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt1 <- dplyr::bind_rows(pamstats)
pamstats <- NULL
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt2, k = number)
  assign(paste0("sequencing.pam.opt2.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt2 <- dplyr::bind_rows(pamstats)
for (number in numbers) {
  clusterpam <- wcKMedoids(sequencing.opt3, k = number)
  assign(paste0("sequencing.pam.opt3.", number), clusterpam, envir = .GlobalEnv)
  pamstats[[number]] <- clusterpam$stats
}
pamstats.opt3 <- dplyr::bind_rows(pamstats)

# QUALITY METRICS
rownames(pamstats.opt1) <- numbers
PAM.ASW.Opt1 <- as.matrix(pamstats.opt1$ASW)
colnames(PAM.ASW.Opt1) <- c("ASW opt1")
PAM.ASW.Opt2 <- as.matrix(pamstats.opt2$ASW)
colnames(PAM.ASW.Opt2) <- c("ASW opt2")
PAM.ASW.Opt3 <- as.matrix(pamstats.opt3$ASW)
colnames(PAM.ASW.Opt3) <- c("ASW opt3")
PAM.ASW <- bind_cols(PAM.ASW.Opt1, PAM.ASW.Opt2, PAM.ASW.Opt3)
PAM.ASW <- PAM.ASW %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.ASW$rowname <- as.numeric(PAM.ASW$rowname)

rownames(pamstats.opt1) <- numbers
PAM.HC.Opt1 <- as.matrix(pamstats.opt1$HC)
colnames(PAM.HC.Opt1) <- c("HC opt1")
PAM.HC.Opt2 <- as.matrix(pamstats.opt2$HC)
colnames(PAM.HC.Opt2) <- c("HC opt2")
PAM.HC.Opt3 <- as.matrix(pamstats.opt3$HC)
colnames(PAM.HC.Opt3) <- c("HC opt3")
PAM.HC <- bind_cols(PAM.HC.Opt1, PAM.HC.Opt2, PAM.HC.Opt3)
PAM.HC <- PAM.HC %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.HC$rowname <- as.numeric(PAM.HC$rowname)

rownames(pamstats.opt1) <- numbers
PAM.PBC.Opt1 <- as.matrix(pamstats.opt1$PBC)
colnames(PAM.PBC.Opt1) <- c("PBC opt1")
PAM.PBC.Opt2 <- as.matrix(pamstats.opt2$PBC)
colnames(PAM.PBC.Opt2) <- c("PBC opt2")
PAM.PBC.Opt3 <- as.matrix(pamstats.opt3$PBC)
colnames(PAM.PBC.Opt3) <- c("PBC opt3")
PAM.PBC <- bind_cols(PAM.PBC.Opt1, PAM.PBC.Opt2, PAM.PBC.Opt3)
PAM.PBC <- PAM.PBC %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.PBC$rowname <- as.numeric(PAM.PBC$rowname)

rownames(pamstats.opt1) <- numbers
PAM.R2.Opt1 <- as.matrix(pamstats.opt1$R2)
colnames(PAM.R2.Opt1) <- c("R2 opt1")
PAM.R2.Opt2 <- as.matrix(pamstats.opt2$R2)
colnames(PAM.R2.Opt2) <- c("R2 opt2")
PAM.R2.Opt3 <- as.matrix(pamstats.opt3$R2)
colnames(PAM.R2.Opt3) <- c("R2 opt3")
PAM.R2 <- bind_cols(PAM.R2.Opt1, PAM.R2.Opt2, PAM.R2.Opt3)
PAM.R2 <- PAM.R2 %>% rownames_to_column() %>% melt() %>% mutate(group = "pam")
PAM.R2$rowname <- as.numeric(PAM.R2$rowname)

PAM.ASW %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "ASW value", type = "viridis") +
  labs(title = "Sequencing - ASW (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "dissimilarity option", labels = c("1", "2", "3")) +
  ylab("number of clusters") +
  ylim(1,21) +
  theme_bw()

PAM.HC %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "ASW value", type = "viridis") +
  labs(title = "Sequencing - ASW (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "dissimilarity option", labels = c("1", "2", "3")) +
  ylab("number of clusters") +
  ylim(1,21) +
  theme_bw()

PAM.PBC %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "ASW value", type = "viridis") +
  labs(title = "Sequencing - ASW (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "dissimilarity option", labels = c("1", "2", "3")) +
  ylab("number of clusters") +
  ylim(1,21) +
  theme_bw()

PAM.R2 %>% mutate(clusters = rowname + 1) %>%
ggplot(aes(x = variable, y = clusters, fill = value)) +
  #facet_grid(. ~ group, scales = "free") +
  geom_tile() +
  scale_fill_continuous(name = "ASW value", type = "viridis") +
  labs(title = "Sequencing - ASW (optimal 1)", caption = "Average silhouette width (ASW) is the coherence of assignments, high coherence indicates high between-group distances and strong
within-group homogeneity \n Dissimiarlity options:\n Option 1: Optimal matching of spell sequences, low expansion cost, low weight, using our custom cost matrix \n Option 2: Optimal matching of transition sequences using our custom cost matrix \n Option 3: Optimal matching of transition sequences, low weight, using our custom cost matrix") +
  scale_x_discrete(name = "dissimilarity option", labels = c("1", "2", "3")) +
  ylab("number of clusters") +
  ylim(1,21) +
  theme_bw()

clusterpam <- wcKMedoids(sequencing.opt2, k = 20)
clusterpam$stats

clusterpam_20 <- clusterpam$clustering
clusterpam_20_fac <- factor(clusterpam_20)#, #labels = paste("Type", 1:20))

seqdplot(vet.seq, group = clusterpam_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))
seqlegend(vet.seq, cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))

vet <- rownames(vet.seq)

vet_df <- as.data.frame(cbind(vet, clusterpam_20))
colnames(vet_df) <- c("id", "cluster")
bg_covariates$id <- as.character(bg_covariates$id)

vet_df <- left_join(vet_df, bg_covariates, by = "id")

degree <- vet_df %>%
  filter(!is.na(highest_degree)) %>%
  group_by(highest_degree) %>%
  mutate(total = n()) %>%
  group_by(cluster, highest_degree) %>%
  mutate(percent = n()/total) %>% distinct(highest_degree, cluster, percent) %>%
  group_by(highest_degree) %>% mutate(sum = sum(percent))

degree$cluster <- as.factor(degree$cluster)
degree$highest_degree <- factor(degree$highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd"))
degree <- degree %>% filter(!is.na(highest_degree))

degree <- as.data.frame(degree)

ggplot(degree, aes(cluster, highest_degree, fill= percent)) + 
  geom_tile()+
  scale_fill_gradient(low="white", high="blue")+
  theme_classic()+
  labs(title = "Clustering X Degree --before normalization")

year_entered_workforce_bin <- vet_df %>%
  filter(!is.na(year_entered_workforce_bin)) %>%
  group_by(year_entered_workforce_bin) %>%
  mutate(total = n()) %>%
  group_by(cluster, year_entered_workforce_bin) %>%
  mutate(percent = n()/total) %>% distinct(cluster, year_entered_workforce_bin, percent) %>%
  group_by(year_entered_workforce_bin) %>% mutate(sum = sum(percent))

year_entered_workforce_bin$cluster <- as.factor(year_entered_workforce_bin$cluster)
#irr_bin$highest_degree <- factor(irr_bin$highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd"))
#degree <- degree %>% filter(!is.na(highest_degree))

year_entered_workforce_bin <- as.data.frame(year_entered_workforce_bin)

seqdplot(vet.seq, group = clusterpam_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))

ggplot(year_entered_workforce_bin, aes(cluster, year_entered_workforce_bin, fill= percent)) + 
  geom_tile()+
  scale_fill_gradient(low="white", high="blue")+
  theme_classic()+
  labs(title = "Clustering X Degree --before normalization")


transition_matrix <- seqtrate(seq.20, weighted=FALSE, count=TRUE)
round(transition_matrix,2)
diag(transition_matrix) = 0
round(transition_matrix,2)
rowsum <- apply(transition_matrix, 1, sum)
for(i in 1:nrow(transition_matrix)) {
  for (j in 1:ncol(transition_matrix)){
    transition_matrix[i,j] = transition_matrix[i,j]/rowsum[i]
  }
}
for(j in 1:ncol(transition_matrix)){
      transition_matrix[7,j] = transition_matrix[7,j] = 0
}
transition_matrix <- round(transition_matrix,2)
cost_matrix <- 2-transition_matrix
round(cost_matrix,2)
diag(cost_matrix) = 0
cost_matrix <- round(cost_matrix,2)

sequencing.opt1 <- seqdist(seq.10, method = "OMspell", indel = "auto", sm = cost_matrix, with.missing = TRUE, otto = 0, expcost = 0)

clusterpam <- wcKMedoids(sequencing.opt1, k = 20)
clusterpam$stats

clusterpam_20 <- clusterpam$clustering
clusterpam_20_fac <- factor(clusterpam_20)#, #labels = paste("Type", 1:20))

#seqdplot(seq.20, group = clusterpam_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
#         cpal = c(uva_color_palette[1], uva_color_palette[2],
#                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
#                  uva_color_palette[5], "#CBBEB5", "dark gray"))
#seqlegend(seq.10, cpal = c(uva_color_palette[1], uva_color_palette[2],
#                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
#                  uva_color_palette[5], "#CBBEB5", "dark gray"))

all <- rownames(seq.20)

all_df <- as.data.frame(cbind(all, clusterpam_20))
colnames(all_df) <- c("id", "cluster")
bg_covariates$id <- as.character(bg_covariates$id)

all_df <- left_join(all_df, bg_covariates, by = "id")

veteran <- all_df %>%
  filter(!is.na(veteran)) %>%
  group_by(veteran) %>%
  mutate(total = n()) %>%
  group_by(cluster, veteran) %>%
  mutate(percent = n()/total) %>% distinct(veteran, cluster, percent) %>%
  group_by(veteran) %>% mutate(sum = sum(percent))

veteran$cluster <- as.factor(veteran$cluster)
#degree$veteran <- factor(degree$highest_degree, levels = c("highschool", "GED/diploma", "associates", "bachelors", "masters", "phd"))
veteran <- veteran %>% filter(!is.na(veteran))

veteran <- as.data.frame(veteran)

seqdplot(seq.20, group = clusterpam_20_fac, border = NA, use.layout = TRUE, cols = 5, withlegend = F, sortv = "from.start",
         cpal = c(uva_color_palette[1], uva_color_palette[2],
                  uva_color_palette[4], uva_color_palette[6], uva_color_palette[9],
                  uva_color_palette[5], "#CBBEB5", "dark gray"))
ggplot(veteran, aes(cluster, veteran, fill= percent)) + 
  geom_tile()+
  scale_fill_gradient(low="white", high="blue")+
  theme_classic()+
  labs(title = "Clustering X Degree --before normalization")

```
